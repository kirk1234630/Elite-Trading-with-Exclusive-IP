<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Elite Trading AI Dashboard</title>
  <script src="https://s3.tradingview.com/tv.js"></script>
  <style>
    /* Add styling for tab bar, cards, modal, newsletter, and chat as needed */
  </style>
</head>
<body>
<div id="newsletter" style="padding:2em;background:#232c4c;color:#fff;border-radius:16px;margin:1em 0;"></div>
<div>
  <button onclick="switchTab('priority')">Priority</button>
  <button onclick="switchTab('meanrev')">Mean Reversion</button>
  <button onclick="switchTab('gn1')">Golden Nugget 1</button>
  <button onclick="switchTab('gn2')">Golden Nugget 2</button>
</div>
<div id="stockGrid"></div>

<!-- Detail modal -->
<div id="modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:#000a;">
  <div id="modalContent" style="max-width:800px;margin:48px auto;background:#fff;padding:2em;border-radius:16px;">
    <button onclick="closeModal()">X</button>
    <div id="modalBody"></div>
  </div>
</div>

<!-- AI Chat widget -->
<div style="position:fixed;bottom:24px;right:24px;background:#fff;padding:1em;border-radius:12px;width:350px;">
  <div id="chatBox" style="height:120px;overflow:auto;font-size:.93em;margin-bottom:.8em"></div>
  <input id="chatInput" style="width:65%;padding:.5em;" placeholder="Ask AI...">
  <button onclick="sendChat()">Send</button>
</div>

<script>
// --- Config ---
const BACKEND_URL = 'https://elite-trading-with-exclusive-ip.onrender.com';
const TAB_FILES = {
  priority: '2025-11-20-watchlist-Priority.csv',
  meanrev: '2025-11-20-watchlist.csv',
  gn1: '2025-11-20-watchlist-GN1.csv',
  gn2: '2025-11-20-watchlist-GN2.csv'
};

// --- State ---
let stockData = {};
let currentTab = 'priority';

// --- Helper: CSV parse ---
function parseCSV(str) {
  const [header, ...lines] = str.trim().split("\n");
  const keys = header.split(",");
  return lines.map(line => {
    const vals = line.split(",");
    let row = {};
    keys.forEach((key, i) => row[key.trim()] = vals[i] ? vals[i].trim() : '');
    return row;
  });
}

// --- Fetch, Newsletter, and Stock Grid Logic ---
async function loadTab(tab) {
  currentTab = tab;
  const res = await fetch(`/${TAB_FILES[tab]}`);
  const csv = await res.text();
  const rows = parseCSV(csv);
  stockData[tab] = rows;

  if (tab === 'priority') generateNewsletter(rows);
  renderGrid(tab);
}
function switchTab(tab) { loadTab(tab); }

async function generateNewsletter(rows) {
  const prompt = `Write a trading newsletter summary for these tickers including mean revision, RSI, regime, highlights and unique observations:\n` +
    rows.map(r=>`${r.Symbol} $${r.Last} | Chg: ${r.Change} | MeanRev: ${r['mean revision']} | Regime: ${r['Regime Detection']} | RSI: ${r['RSIWIlder']}`).join("\n");
  const aiText = await callAI(prompt);
  document.getElementById('newsletter').innerText = aiText || 'Newsletter unavailable.';
}

// --- Stock Grid ---
function renderGrid(tab) {
  const rows = stockData[tab] || [];
  document.getElementById('stockGrid').innerHTML = rows.slice(0,10).map((row,idx) => `
    <div style="background:#1b2343;color:#c6e2f7;margin:1em 0;padding:1.2em;border-radius:10px;cursor:pointer"
         onclick="showModal('${tab}', ${idx})">
      <div><b>${row.Symbol || row['Symbol.1']}</b> $${row.Last || row['Last']}</div>
      <div>Change: ${row.Change || row['Change']}, RSI: ${row['RSIWIlder']}, MR: ${row['mean revision']}, Regime: ${row['Regime Detection']}</div>
    </div>`).join('');
}

// --- Detail Modal ---
function showModal(tab, idx) {
  const row = stockData[tab][idx];
  const sym = row.Symbol || row['Symbol.1'];
  const modalBody = document.getElementById('modalBody');
  modalBody.innerHTML = `
    <h2>${sym} ($${row.Last})</h2>
    <b>Change:</b> ${row.Change}<br>
    <b>Mean Rev:</b> ${row['mean revision']}<br>
    <b>RSI:</b> ${row['RSIWIlder']}<br>
    <b>Regime:</b> ${row['Regime Detection']}<br>
    <b>Volume:</b> ${row.Volume}<br>
    <b>Institutional Score:</b> ${row['Inst 33']}<br>
    <br>
    <div><b>AI Analysis:</b><div id="aiDetailBox">Loading...</div></div>
    <div id="tvChart" style="height:400px;width:100%"></div>
  `;
  document.getElementById('modal').style.display = '';
  // TradingView chart
  new TradingView.widget({
    "container_id": "tvChart",
    "width": "100%",
    "height": 400,
    "symbol": sym,
    "interval": "30",
    "timezone": "America/New_York",
    "theme": "dark",
    "style": "1",
    "hide_top_toolbar": true,
    "save_image": false,
    "hide_legend": false
  });
  // AI Expanded
  callAI(`Deep actionable trading analysis for ${sym}: price $${row.Last}, mean revision ${row['mean revision']}, RSI ${row['RSIWIlder']}, Regime ${row['Regime Detection']}, highlights, opportunity, technical setup, and risk managment.`)
    .then(txt => document.getElementById('aiDetailBox').innerText = txt || 'Unavailable');
}
function closeModal() { document.getElementById('modal').style.display = 'none'; }

// --- Central AI function ---
async function callAI(userPrompt) {
  try {
    const resp = await fetch(`${BACKEND_URL}/api/ai-analyze`, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        model: 'sonar',
        messages:[{role:'user', content: userPrompt}],
        temperature: 0.35,
        max_tokens: 400
      })
    });
    if (resp.ok) {
      const data = await resp.json();
      return data.choices?.[0]?.message?.content || '';
    }
    return 'Error loading AI response';
  } catch(e) {
    return 'AI unavailable';
  }
}

// --- AI Chat ---
let chatHistory = [];
async function sendChat() {
  const box = document.getElementById('chatBox');
  const inp = document.getElementById('chatInput');
  const msg = inp.value.trim();
  if(!msg) return;
  box.innerHTML += `<div style="color:#0af"><b>You:</b>${msg}</div>`;
  inp.value = '';
  const aiAnswer = await callAI(msg);
  box.innerHTML += `<div style="color:#444"><b>AI:</b> ${aiAnswer}</div>`;
  box.scrollTop = box.scrollHeight;
}

// --- Init (load priority by default) ---
window.onload = () => loadTab('priority');
</script>
</body>
</html>
