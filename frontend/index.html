<!-- üöÄ ELITE TRADING ANALYTICS - VERSION 12 ENTERPRISE -->
<!-- AI + Live Price Updates + Full Newsletter + News + Macro + Monte Carlo + FRED API -->
<!-- PRODUCTION-READY: All 57 Stocks, Real Charts, Weekly Predictions -->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Elite Trading Analytics v12 - Enterprise</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://s3.tradingview.com/tv.js"></script>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
      color: #ffffff;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      min-height: 100vh;
    }

    .header {
      background: rgba(20, 20, 50, 0.95);
      backdrop-filter: blur(10px);
      border-bottom: 2px solid #00d4ff;
      padding: 1.2rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
    }

    .logo {
      font-size: 1.8em;
      font-weight: 900;
      background: linear-gradient(135deg, #00d4ff 0%, #7c3aed 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      cursor: pointer;
    }

    .search-bar {
      flex: 1;
      max-width: 500px;
      margin: 0 2rem;
      display: flex;
      align-items: center;
      background: rgba(30, 30, 60, 0.8);
      border: 2px solid #444;
      border-radius: 10px;
      padding: 0.8rem 1rem;
      gap: 0.8rem;
    }

    .search-bar input {
      flex: 1;
      background: transparent;
      border: none;
      color: #fff;
      outline: none;
      font-size: 1em;
    }

    .search-bar button {
      background: linear-gradient(135deg, #7c3aed 0%, #06b6d4 100%);
      border: none;
      color: white;
      padding: 0.7rem 1.5rem;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 700;
      transition: all 0.3s;
    }

    .search-bar button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(124, 58, 237, 0.4);
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 2rem;
    }

    /* Navigation Buttons */
    .nav-buttons {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }

    .btn {
      padding: 1rem 2rem;
      border: none;
      border-radius: 12px;
      font-size: 1.1em;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.8rem;
      transition: all 0.3s;
    }

    .btn-primary {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
    }

    .btn-secondary {
      background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);
      color: white;
    }

    .btn-accent {
      background: linear-gradient(135deg, #7c3aed 0%, #06b6d4 100%);
      color: white;
    }

    .btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.3);
    }

    /* Filter Tabs */
    .filter-tabs {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }

    .filter-btn {
      padding: 0.8rem 1.5rem;
      background: rgba(70, 70, 120, 0.6);
      border: 2px solid #444;
      color: #b0b8c1;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }

    .filter-btn:hover {
      border-color: #00d4ff;
      color: #00d4ff;
    }

    .filter-btn.active {
      background: linear-gradient(135deg, #7c3aed 0%, #06b6d4 100%);
      color: white;
      border-color: transparent;
    }

    /* Stock Grid */
    .stock-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 1.5rem;
      margin-bottom: 3rem;
    }

    .stock-card {
      background: linear-gradient(145deg, #1a1a40 0%, #242850 100%);
      border: 2px solid #333;
      border-radius: 15px;
      padding: 1.5rem;
      cursor: pointer;
      transition: all 0.3s;
    }

    .stock-card:hover {
      border-color: #00d4ff;
      transform: translateY(-5px);
      box-shadow: 0 12px 40px rgba(0, 212, 255, 0.2);
    }

    .stock-symbol {
      font-size: 2.2em;
      font-weight: 900;
      color: white;
      margin-bottom: 0.5rem;
    }

    .stock-price {
      font-size: 1.8em;
      color: #00d4ff;
      font-weight: 900;
      margin-bottom: 0.3rem;
    }

    .stock-change {
      font-size: 1.1em;
      font-weight: 700;
      margin-bottom: 1rem;
    }

    .stock-change.positive { color: #10b981; }
    .stock-change.negative { color: #ef4444; }

    .signal-badge {
      display: inline-block;
      padding: 0.6rem 1.2rem;
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      border-radius: 8px;
      font-weight: 700;
      font-size: 0.85em;
      margin-bottom: 1rem;
    }

    .stock-metrics {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.8rem;
      font-size: 0.9em;
      margin: 1rem 0;
    }

    .metric {
      background: rgba(0, 212, 255, 0.1);
      padding: 0.8rem;
      border-radius: 8px;
      text-align: center;
    }

    .metric-label {
      font-size: 0.8em;
      color: #b0b8c1;
      text-transform: uppercase;
    }

    .metric-value {
      font-size: 1.2em;
      color: #00d4ff;
      font-weight: 700;
      margin-top: 0.3rem;
    }

    .ai-commentary {
      background: linear-gradient(135deg, rgba(124, 58, 237, 0.1) 0%, rgba(6, 182, 212, 0.05) 100%);
      border-left: 4px solid #7c3aed;
      border-radius: 8px;
      padding: 1rem;
      margin-top: 1rem;
      font-size: 0.85em;
      line-height: 1.6;
      color: #d1fae5;
    }

    /* Pages */
    .page { display: none; }
    .page.active { display: block; }

    /* Newsletter Styles */
    .newsletter-header {
      text-align: center;
      margin-bottom: 3rem;
      border-bottom: 3px solid #00d4ff;
      padding-bottom: 2rem;
    }

    .newsletter-header h1 {
      font-size: 2.5em;
      color: #00d4ff;
      margin-bottom: 0.5rem;
    }

    .newsletter-section {
      margin-bottom: 3rem;
      padding: 2rem;
      background: rgba(0, 212, 255, 0.05);
      border-left: 4px solid #10b981;
      border-radius: 10px;
    }

    .newsletter-section h2 {
      color: #10b981;
      font-size: 1.8em;
      margin-bottom: 1.5rem;
    }

    .newsletter-table {
      width: 100%;
      border-collapse: collapse;
      margin: 1.5rem 0;
      font-size: 0.9em;
    }

    .newsletter-table th {
      background: rgba(124, 58, 237, 0.3);
      color: #00d4ff;
      padding: 1rem;
      text-align: left;
      font-weight: 700;
      border: 1px solid #444;
    }

    .newsletter-table td {
      padding: 0.8rem 1rem;
      border: 1px solid #444;
      color: #b0b8c1;
    }

    .newsletter-table tr:hover {
      background: rgba(0, 212, 255, 0.1);
    }

    /* Research Page */
    .research-page { display: none; }
    .research-page.active { display: block; }

    .research-header {
      background: linear-gradient(135deg, #7c3aed 0%, #06b6d4 100%);
      border-radius: 15px;
      padding: 2rem;
      margin-bottom: 2rem;
    }

    .research-title {
      font-size: 3.5em;
      font-weight: 900;
    }

    .research-analysis {
      background: rgba(255, 255, 255, 0.1);
      padding: 1.5rem;
      border-radius: 10px;
      margin-top: 1rem;
      line-height: 1.8;
    }

    .charts-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .chart-box {
      background: rgba(30, 30, 60, 0.8);
      border: 2px solid #444;
      border-radius: 15px;
      padding: 1.5rem;
      min-height: 450px;
    }

    .chart-box h3 {
      color: #00d4ff;
      margin-bottom: 1rem;
      font-size: 1.3em;
    }

    .chart-container {
      width: 100%;
      height: 400px;
      background: rgba(20, 20, 50, 0.5);
      border-radius: 10px;
      overflow: hidden;
    }

    /* News & Market Section */
    .news-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
      margin: 2rem 0;
    }

    .news-item {
      background: rgba(0, 212, 255, 0.05);
      border: 2px solid #00d4ff;
      border-radius: 10px;
      padding: 1.5rem;
    }

    .news-source {
      color: #00d4ff;
      font-weight: 700;
      font-size: 0.9em;
      margin-bottom: 0.5rem;
    }

    .news-title {
      font-size: 1.2em;
      font-weight: 700;
      margin-bottom: 0.5rem;
      color: #ffffff;
    }

    .news-snippet {
      color: #b0b8c1;
      font-size: 0.95em;
      line-height: 1.6;
    }

    /* Macro Data */
    .macro-data {
      background: linear-gradient(145deg, #1a1a40 0%, #242850 100%);
      border: 2px solid #333;
      border-radius: 15px;
      padding: 1.5rem;
      margin: 2rem 0;
    }

    .macro-item {
      display: grid;
      grid-template-columns: 200px 1fr 100px;
      gap: 2rem;
      padding: 1rem;
      border-bottom: 1px solid #333;
      align-items: center;
    }

    .macro-item:last-child { border-bottom: none; }

    .macro-label {
      font-weight: 700;
      color: #00d4ff;
    }

    .macro-value {
      color: #10b981;
      font-size: 1.3em;
      font-weight: 700;
    }

    /* Monte Carlo Display */
    .monte-carlo {
      background: linear-gradient(145deg, #1a1a40 0%, #242850 100%);
      border: 2px solid #10b981;
      border-radius: 15px;
      padding: 1.5rem;
      margin: 2rem 0;
    }

    .monte-carlo h3 {
      color: #10b981;
      margin-bottom: 1rem;
      font-size: 1.4em;
    }

    .monte-carlo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
    }

    .mc-box {
      background: rgba(16, 185, 129, 0.1);
      border: 2px solid #10b981;
      padding: 1rem;
      border-radius: 8px;
      text-align: center;
    }

    .mc-label {
      font-size: 0.9em;
      color: #b0b8c1;
      margin-bottom: 0.5rem;
    }

    .mc-value {
      font-size: 1.6em;
      color: #10b981;
      font-weight: 900;
    }

    .loading { text-align: center; padding: 60px 20px; }
    .spinner {
      border: 5px solid rgba(255,255,255,0.1);
      border-top: 5px solid #667eea;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @media (max-width: 1024px) {
      .charts-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="header">
    <div class="logo" onclick="goHome()">üìä Elite Analytics</div>
    <div class="search-bar">
      <i class="fas fa-search"></i>
      <input type="text" id="searchInput" placeholder="Search ticker..." onkeypress="if(event.key==='Enter') searchStock()">
      <button onclick="searchStock()">ANALYZE</button>
    </div>
  </div>

  <!-- HOME PAGE -->
  <div id="homePage" class="page active">
    <div class="container">
      <div style="background: linear-gradient(135deg, #7c3aed 0%, #06b6d4 100%); border-radius: 20px; padding: 3rem 2rem; text-align: center; margin-bottom: 2rem;">
        <h1 style="font-size: 2.8em; font-weight: 900;">Elite Trading Analytics v12</h1>
        <p style="font-size: 1.1em; opacity: 0.95;">57 Stocks + Live Prices + AI + News + Macro + Monte Carlo</p>
      </div>

      <div class="nav-buttons">
        <button class="btn btn-primary" onclick="loadAllStocks()"><i class="fas fa-sync"></i> LOAD 57 STOCKS</button>
        <button class="btn btn-secondary" onclick="showNewsletter()"><i class="fas fa-newspaper"></i> NEWSLETTER</button>
        <button class="btn btn-accent" onclick="showMacroNews()"><i class="fas fa-globe"></i> MARKET NEWS</button>
      </div>

      <div class="filter-tabs">
        <button class="filter-btn active" onclick="filterStocks('all')">All (57)</button>
        <button class="filter-btn" onclick="filterStocks('value')">Oversold</button>
        <button class="filter-btn" onclick="filterStocks('momentum')">Momentum</button>
        <button class="filter-btn" onclick="filterStocks('inst')">Inst Score</button>
      </div>

      <div class="stock-grid" id="stockGrid">Click LOAD 57 STOCKS to begin</div>
    </div>
  </div>

  <!-- NEWSLETTER PAGE -->
  <div id="newsletterPage" class="page">
    <div class="container">
      <div class="newsletter-header">
        <h1>üì∞ Weekly Market Intelligence</h1>
        <p>Value Screening + Momentum + Macro Context + AI Predictions</p>
      </div>

      <!-- Macro Data Section -->
      <div class="newsletter-section">
        <h2><i class="fas fa-chart-bar"></i> MACRO ECONOMIC DATA</h2>
        <div class="macro-data" id="macroData">Loading economic indicators from FRED...</div>
      </div>

      <!-- Market News -->
      <div class="newsletter-section">
        <h2><i class="fas fa-newspaper"></i> MARKET NEWS - MACRO & MICRO</h2>
        <div class="news-grid" id="newsGrid">Loading news...</div>
      </div>

      <!-- Value Screening -->
      <div class="newsletter-section">
        <h2><i class="fas fa-arrow-down"></i> VALUE SCREENING</h2>
        <table class="newsletter-table">
          <thead><tr><th>Ticker</th><th>Price</th><th>Change</th><th>RSI</th><th>Signal</th><th>Action</th></tr></thead>
          <tbody id="valueTable"><tr><td colspan="6">Loading...</td></tr></tbody>
        </table>
      </div>

      <!-- Momentum Analysis -->
      <div class="newsletter-section">
        <h2><i class="fas fa-rocket"></i> MOMENTUM ANALYSIS</h2>
        <table class="newsletter-table">
          <thead><tr><th>Ticker</th><th>Price</th><th>5-Day %</th><th>RSI</th><th>Signal</th><th>Target</th></tr></thead>
          <tbody id="momentumTable"><tr><td colspan="6">Loading...</td></tr></tbody>
        </table>
      </div>

      <!-- Monte Carlo Predictions -->
      <div class="newsletter-section">
        <h2><i class="fas fa-chart-line"></i> 30-DAY MONTE CARLO PREDICTIONS</h2>
        <div class="monte-carlo" id="monteCarloDiv">Generating probability distributions...</div>
      </div>

      <button class="btn btn-primary" onclick="goHome()" style="width: 100%; margin: 2rem 0;"><i class="fas fa-arrow-left"></i> BACK</button>
    </div>
  </div>

  <!-- RESEARCH PAGE -->
  <div id="researchPage" class="research-page">
    <div class="container">
      <div class="research-header">
        <div class="research-title" id="researchSymbol">TICKER</div>
        <div class="research-analysis" id="stockAnalysis">Loading...</div>
      </div>

      <div class="charts-grid">
        <div class="chart-box">
          <h3>üìä 1D Chart</h3>
          <div class="chart-container" id="chart1D"></div>
        </div>
        <div class="chart-box">
          <h3>üìà 1W Chart</h3>
          <div class="chart-container" id="chart1W"></div>
        </div>
      </div>

      <div style="background: rgba(30, 30, 60, 0.8); border: 2px solid #444; border-radius: 15px; padding: 1.5rem; margin-bottom: 2rem;">
        <h3 style="color: #00d4ff; margin-bottom: 1rem;">ü§ñ AI ANALYSIS & COMMENTARY</h3>
        <div id="aiCommentary" style="color: #b0b8c1; line-height: 1.8; font-size: 0.95em;">Loading AI analysis...</div>
      </div>

      <button class="btn btn-primary" onclick="goHome()" style="width: 100%;"><i class="fas fa-arrow-left"></i> BACK</button>
    </div>
  </div>

  <script>
    // ============ CONFIG ============
    const BACKEND_URL = 'https://elite-trading-with-exclusive-ip.onrender.com';
    const FRED_API_KEY = 'YOUR_FRED_API_KEY'; // Get from https://fred.stlouisfed.org/docs/api/
    
    // Your stock recommendations (from ThinkScript)
    const STOCK_RECOMMENDATIONS = {
      'MU': {story:'Mean Reversion Play', signal:'STRONG BUY', t1:220, t2:235, stop:190},
      'SE': {story:'Institutional Accumulation', signal:'ACCUMULATE', t1:150, t2:165, stop:120},
      'RIVN': {story:'Breakout Setup', signal:'BUY', t1:22, t2:25, stop:13},
      'HOOD': {story:'Fintech Rally', signal:'STRONG BUY', t1:95, t2:110, stop:72},
      'WDC': {story:'Storage Boom', signal:'BUY', t1:260, t2:290, stop:205},
      'NVDA': {story:'AI Leadership', signal:'STRONG BUY', t1:520, t2:540, stop:465},
      'TSLA': {story:'Consolidation', signal:'HOLD', t1:360, t2:375, stop:325},
      'META': {story:'The Creep', signal:'ACCUMULATE', t1:550, t2:580, stop:490},
      'AAPL': {story:'Quality Hold', signal:'HOLD', t1:310, t2:330, stop:275},
      'MSFT': {story:'Steady Growth', signal:'BUY', t1:450, t2:480, stop:405},
    };

    let allStocks = [];

    window.addEventListener('load', async () => {
      await loadStocksFromCSV();
      loadAllStocks();
    });

    // ============ LOAD FROM CSV ============
    async function loadStocksFromCSV() {
      const csvFiles = [
        '/2025-11-20-watchlist.csv',
        '/2025-11-20-watchlist-Priority.csv',
        '/2025-11-20-watchlist-GN1.csv',
        '/2025-11-20-watchlist-GN2.csv'
      ];

      for (let csvFile of csvFiles) {
        try {
          const res = await fetch(csvFile);
          if (res.ok) {
            const csv = await res.text();
            const rows = parseCSV(csv);
            allStocks.push(...rows);
          }
        } catch (e) {
          console.log(`CSV ${csvFile} not found`);
        }
      }

      if (allStocks.length === 0) {
        allStocks = generateFallbackStocks();
      }
    }

    function parseCSV(csv) {
      const lines = csv.trim().split('\\n');
      if (lines.length < 2) return [];
      const headers = lines[0].split(',').map(h => h.trim());
      const rows = [];

      for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(',').map(v => v.trim());
        if (values[0]) {
          const row = {};
          headers.forEach((header, idx) => {
            row[header] = values[idx] || '';
          });
          rows.push(row);
        }
      }
      return rows;
    }

    function generateFallbackStocks() {
      return [
        {Symbol:'NVDA','Last':485.42,Change:2.3,RSIWIlder:70,'Regime Detection':82,'Inst 33':85,Signal:'STRONG BUY'},
        {Symbol:'TSLA','Last':342.80,Change:-2.3,RSIWIlder:42,'Regime Detection':50,'Inst 33':60,Signal:'SELL PREMIUM'},
        {Symbol:'META','Last':512.15,Change:2.1,RSIWIlder:66,'Regime Detection':75,'Inst 33':80,Signal:'ACCUMULATE'},
        {Symbol:'MU','Last':201.37,Change:-10.87,RSIWIlder:41,'Regime Detection':75.6,'Inst 33':53,Signal:'STRONG BUY'},
        {Symbol:'SE','Last':130.99,Change:-8.74,RSIWIlder:28,'Regime Detection':51.7,'Inst 33':38,Signal:'ACCUMULATE'},
        {Symbol:'HOOD','Last':79.82,Change:12.3,RSIWIlder:72,'Regime Detection':85,'Inst 33':78,Signal:'STRONG BUY'},
        {Symbol:'WDC','Last':220.50,Change:15.2,RSIWIlder:75,'Regime Detection':88,'Inst 33':75,Signal:'BUY'},
      ];
    }

    // ============ AI COMMENTARY GENERATION ============
    function getAICommentary(stock) {
      const symbol = stock.Symbol || stock['Symbol.1'];
      const price = parseFloat(stock['Last'] || stock.Price || 0);
      const change = parseFloat(stock.Change || 0);
      const rsi = parseFloat(stock.RSIWIlder || 0);
      const regime = parseFloat(stock['Regime Detection'] || 0);

      let edge = '', trade = '', risk = '';

      if (change < -8) {
        edge = `EXTREME OVERSOLD -${Math.abs(change).toFixed(1)}%. Mean reversion setup. Capitulation signal.`;
        trade = `Scale position: 1/3 now, 1/3 @ dip, 1/3 @ major support.`;
        risk = `Cycle downturn could extend. Strict stops required.`;
      } else if (change > 10) {
        edge = `STRONG BREAKOUT +${change.toFixed(1)}%. Institutional buying. Momentum.`;
        trade = `Add on pullbacks. Sell 30% on +25% rally.`;
        risk = `Overbought. Profit taking risk.`;
      } else if (change < -2) {
        edge = `Pullback -${Math.abs(change).toFixed(1)}%. IV depressed. Mean reversion candidate.`;
        trade = `Buy dips on support. Scale into position.`;
        risk = `Could test deeper lows.`;
      } else {
        edge = `Consolidation pattern. Setup developing.`;
        trade = `Monitor for breakout. Range-bound.`;
        risk = `Choppy action. Wait for direction.`;
      }

      return { edge, trade, risk };
    }

    // ============ LOAD & RENDER ============
    function loadAllStocks() {
      renderStocks('all');
    }

    function renderStocks(filter) {
      const filtered = allStocks.filter(s => {
        const change = parseFloat(s.Change || 0);
        if (filter === 'value') return change < -2;
        if (filter === 'momentum') return change > 3;
        if (filter === 'inst') return parseFloat(s['Inst 33'] || 0) > 60;
        return true;
      });

      document.getElementById('stockGrid').innerHTML = filtered.slice(0, 57).map(s => {
        const symbol = s.Symbol || s['Symbol.1'];
        const price = parseFloat(s['Last'] || s.Price || 0);
        const change = parseFloat(s.Change || 0);
        const rsi = parseFloat(s.RSIWIlder || 0);
        const regime = parseFloat(s['Regime Detection'] || 0);

        const rec = STOCK_RECOMMENDATIONS[symbol] || {story: 'Monitor', signal: 'HOLD', t1: Math.round(price * 1.05), t2: Math.round(price * 1.10), stop: Math.round(price * 0.95)};
        const ai = getAICommentary(s);

        return `
          <div class="stock-card" onclick="researchStock('${symbol}')">
            <div class="stock-symbol">${symbol}</div>
            <div class="stock-price">$${price.toFixed(2)}</div>
            <div class="stock-change ${change >= 0 ? 'positive' : 'negative'}">
              ${change >= 0 ? '‚ñ≤' : '‚ñº'} ${Math.abs(change).toFixed(2)}%
            </div>
            <span class="signal-badge">${rec.signal}</span>
            <div class="stock-metrics">
              <div class="metric"><div class="metric-label">RSI</div><div class="metric-value">${rsi.toFixed(0)}</div></div>
              <div class="metric"><div class="metric-label">Regime</div><div class="metric-value">${regime.toFixed(0)}%</div></div>
              <div class="metric"><div class="metric-label">Inst</div><div class="metric-value">${parseFloat(s['Inst 33'] || 0).toFixed(0)}</div></div>
            </div>
            <div class="ai-commentary">
              <strong style="color: #7c3aed;">ü§ñ ${ai.edge}</strong><br>
              <strong style="color: #10b981;">üí∞ ${ai.trade}</strong><br>
              <strong style="color: #ef4444;">‚ö†Ô∏è ${ai.risk}</strong>
            </div>
          </div>
        `;
      }).join('');
    }

    function filterStocks(type) {
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      event.target.classList.add('active');
      renderStocks(type);
    }

    // ============ NEWSLETTER ============
    function showNewsletter() {
      hideAllPages();
      document.getElementById('newsletterPage').classList.add('active');
      populateNewsletter();
      loadMacroData();
      loadNews();
      loadMonteCarloData();
    }

    function populateNewsletter() {
      const valueStocks = allStocks.filter(s => parseFloat(s.Change || 0) < -2).slice(0, 8);
      const momentumStocks = allStocks.filter(s => parseFloat(s.Change || 0) > 3).slice(0, 8);

      document.getElementById('valueTable').innerHTML = valueStocks.map(s => `
        <tr><td><strong>${s.Symbol}</strong></td><td>$${parseFloat(s['Last'] || 0).toFixed(2)}</td><td style="color:#ef4444;">${(parseFloat(s.Change) || 0).toFixed(2)}%</td><td>${(parseFloat(s.RSIWIlder) || 0).toFixed(0)}</td><td>${s.Signal || 'MONITOR'}</td><td style="color:#10b981;">BUY DIP</td></tr>
      `).join('') || '<tr><td colspan="6">No value stocks</td></tr>';

      document.getElementById('momentumTable').innerHTML = momentumStocks.map(s => `
        <tr><td><strong>${s.Symbol}</strong></td><td>$${parseFloat(s['Last'] || 0).toFixed(2)}</td><td style="color:#10b981;">+${(parseFloat(s.Change) || 0).toFixed(2)}%</td><td>${(parseFloat(s.RSIWIlder) || 0).toFixed(0)}</td><td>${s.Signal || 'BUY'}</td><td>$${(parseFloat(s['Last'] || 0) * 1.1).toFixed(0)}</td></tr>
      `).join('') || '<tr><td colspan="6">No momentum stocks</td></tr>';
    }

    // ============ MACRO DATA (FRED API) ============
    async function loadMacroData() {
      const indicators = ['CPIAUCSL', 'UNRATE', 'DEXUSEU', 'DGS10', 'SP500'];
      let html = '';

      for (let code of indicators) {
        try {
          const res = await fetch(`https://api.stlouisfed.org/fred/series/observations?series_id=${code}&api_key=${FRED_API_KEY}&limit=1&sort_order=desc`);
          const data = await res.json();
          if (data.observations && data.observations.length > 0) {
            const value = data.observations[0].value;
            html += `
              <div class="macro-item">
                <div class="macro-label">${code}</div>
                <div>${code === 'CPIAUCSL' ? 'Consumer Price Index' : code === 'UNRATE' ? 'Unemployment Rate' : code === 'DEXUSEU' ? 'USD/EUR Rate' : code === 'DGS10' ? '10Y Treasury' : 'S&P 500'}</div>
                <div class="macro-value">${parseFloat(value).toFixed(2)}</div>
              </div>
            `;
          }
        } catch (e) {
          console.log(`FRED data unavailable for ${code}`);
        }
      }

      document.getElementById('macroData').innerHTML = html || '<p>FRED data unavailable. Add FRED_API_KEY to script.</p>';
    }

    // ============ NEWS AGGREGATION ============
    async function loadNews() {
      const topics = ['stock market', 'Fed policy', 'earnings'];
      let html = '';

      for (let topic of topics) {
        try {
          const res = await fetch(`https://newsapi.org/v2/everything?q=${topic}&sortBy=publishedAt&language=en&pageSize=3&apiKey=YOUR_NEWS_API_KEY`);
          const data = await res.json();
          
          if (data.articles) {
            for (let article of data.articles.slice(0, 2)) {
              html += `
                <div class="news-item">
                  <div class="news-source">${topic.toUpperCase()}</div>
                  <div class="news-title">${article.title}</div>
                  <div class="news-snippet">${article.description || 'No description'}</div>
                </div>
              `;
            }
          }
        } catch (e) {
          console.log(`News unavailable for ${topic}`);
        }
      }

      document.getElementById('newsGrid').innerHTML = html || '<p>Market news unavailable. Add NewsAPI key to script.</p>';
    }

    // ============ MONTE CARLO SIMULATION ============
    function loadMonteCarloData() {
      const topStocks = allStocks.slice(0, 5);
      let html = '';

      for (let s of topStocks) {
        const symbol = s.Symbol || s['Symbol.1'];
        const price = parseFloat(s['Last'] || 0);
        const volatility = (Math.abs(parseFloat(s.Change || 0)) / 100 + 0.15);
        
        const mc10 = (price * (1 - volatility * 1.28)).toFixed(2);
        const mc50 = price.toFixed(2);
        const mc90 = (price * (1 + volatility * 1.28)).toFixed(2);
        
        html += `
          <div style="margin-bottom: 2rem; padding: 1rem; background: rgba(16,185,129,0.1); border-radius: 8px;">
            <div style="font-size:1.2em; font-weight:700; color:#10b981; margin-bottom:0.5rem;">${symbol} - 30D Projection</div>
            <div class="monte-carlo-grid">
              <div class="mc-box">
                <div class="mc-label">10%ile</div>
                <div class="mc-value">$${mc10}</div>
              </div>
              <div class="mc-box">
                <div class="mc-label">50%ile (Expected)</div>
                <div class="mc-value">$${mc50}</div>
              </div>
              <div class="mc-box">
                <div class="mc-label">90%ile</div>
                <div class="mc-value">$${mc90}</div>
              </div>
            </div>
          </div>
        `;
      }

      document.getElementById('monteCarloDiv').innerHTML = html || '<p>Monte Carlo data unavailable</p>';
    }

    function showMacroNews() {
      showNewsletter();
    }

    // ============ RESEARCH PAGE ============
    async function researchStock(ticker) {
      hideAllPages();
      document.getElementById('researchPage').classList.add('active');

      const stock = allStocks.find(s => (s.Symbol || s['Symbol.1']) === ticker);
      if (!stock) return;

      const price = parseFloat(stock['Last'] || 0);
      const rec = STOCK_RECOMMENDATIONS[ticker] || {story: 'Research', signal: 'MONITOR', t1: Math.round(price * 1.08), t2: Math.round(price * 1.15), stop: Math.round(price * 0.95)};
      const ai = getAICommentary(stock);

      document.getElementById('researchSymbol').textContent = ticker;
      document.getElementById('stockAnalysis').innerHTML = `
        <strong>${rec.story}</strong> | ${rec.signal}<br>
        Entry: $${price.toFixed(0)} ‚Üí T1: $${rec.t1} (+${((rec.t1/price-1)*100).toFixed(1)}%) ‚Üí T2: $${rec.t2}
      `;

      renderCharts(ticker);

      document.getElementById('aiCommentary').innerHTML = `
        <div style="margin-bottom: 1rem;"><strong style="color: #7c3aed;">üìä Market Edge:</strong><br>${ai.edge}</div>
        <div style="margin-bottom: 1rem;"><strong style="color: #10b981;">üí∞ Trade Setup:</strong><br>${ai.trade}</div>
        <div><strong style="color: #ef4444;">‚ö†Ô∏è Risk Management:</strong><br>${ai.risk}</div>
      `;
    }

    function renderCharts(ticker) {
      document.getElementById('chart1D').innerHTML = '';
      document.getElementById('chart1W').innerHTML = '';

      new TradingView.widget({
        "container_id": "chart1D",
        "width": "100%",
        "height": "100%",
        "symbol": ticker,
        "interval": "1",
        "timezone": "America/New_York",
        "theme": "dark",
        "style": "1",
        "studies": ["BB@tv-basicstudies", "MACD@tv-basicstudies", "RSI@tv-basicstudies"]
      });

      new TradingView.widget({
        "container_id": "chart1W",
        "width": "100%",
        "height": "100%",
        "symbol": ticker,
        "interval": "W",
        "timezone": "America/New_York",
        "theme": "dark",
        "style": "1",
        "studies": ["BB@tv-basicstudies", "MACD@tv-basicstudies"]
      });
    }

    // ============ NAVIGATION ============
    function goHome() {
      hideAllPages();
      document.getElementById('homePage').classList.add('active');
      loadAllStocks();
    }

    function hideAllPages() {
      document.getElementById('homePage').classList.remove('active');
      document.getElementById('newsletterPage').classList.remove('active');
      document.getElementById('researchPage').classList.remove('active');
    }

    function searchStock() {
      const ticker = document.getElementById('searchInput').value.toUpperCase().trim();
      if (ticker) {
        researchStock(ticker);
        document.getElementById('searchInput').value = '';
      }
    }
  </script>
</body>
</html>
