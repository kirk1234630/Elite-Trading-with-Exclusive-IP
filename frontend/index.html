<!-- üöÄ ELITE TRADING ANALYTICS - VERSION 12.5 ENTERPRISE FINAL -->
<!-- Persistent AI Chat + Live Prices + Single Chart + Deep Commentary + All APIs -->
<!-- Uses Render Environment Variables: FRED, NewsAPI, AlphaVantage, Finnhub, Massive, Perplexity -->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Elite Trading Analytics v12.5 - Enterprise</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://s3.tradingview.com/tv.js"></script>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
      color: #ffffff;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      min-height: 100vh;
    }

    .header {
      background: rgba(20, 20, 50, 0.95);
      backdrop-filter: blur(10px);
      border-bottom: 2px solid #00d4ff;
      padding: 1.2rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
    }

    .logo {
      font-size: 1.8em;
      font-weight: 900;
      background: linear-gradient(135deg, #00d4ff 0%, #7c3aed 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      cursor: pointer;
    }

    .search-bar {
      flex: 1;
      max-width: 500px;
      margin: 0 2rem;
      display: flex;
      align-items: center;
      background: rgba(30, 30, 60, 0.8);
      border: 2px solid #444;
      border-radius: 10px;
      padding: 0.8rem 1rem;
      gap: 0.8rem;
    }

    .search-bar input {
      flex: 1;
      background: transparent;
      border: none;
      color: #fff;
      outline: none;
      font-size: 1em;
    }

    .search-bar button {
      background: linear-gradient(135deg, #7c3aed 0%, #06b6d4 100%);
      border: none;
      color: white;
      padding: 0.7rem 1.5rem;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 700;
    }

    .container { max-width: 1600px; margin: 0 auto; padding: 2rem; }

    .btn {
      padding: 1rem 2rem;
      border: none;
      border-radius: 12px;
      font-size: 1.1em;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.8rem;
      transition: all 0.3s;
    }

    .btn-primary { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
    .btn-secondary { background: linear-gradient(135deg, #ec4899 0%, #db2777 100%); color: white; }
    .btn-accent { background: linear-gradient(135deg, #7c3aed 0%, #06b6d4 100%); color: white; }

    .nav-buttons { display: flex; gap: 1rem; justify-content: center; margin-bottom: 2rem; flex-wrap: wrap; }

    .filter-btn {
      padding: 0.8rem 1.5rem;
      background: rgba(70, 70, 120, 0.6);
      border: 2px solid #444;
      color: #b0b8c1;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
    }

    .filter-btn.active {
      background: linear-gradient(135deg, #7c3aed 0%, #06b6d4 100%);
      color: white;
      border-color: transparent;
    }

    .stock-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 1.5rem;
      margin-bottom: 3rem;
    }

    .stock-card {
      background: linear-gradient(145deg, #1a1a40 0%, #242850 100%);
      border: 2px solid #333;
      border-radius: 15px;
      padding: 1.5rem;
      cursor: pointer;
      transition: all 0.3s;
    }

    .stock-card:hover {
      border-color: #00d4ff;
      transform: translateY(-5px);
      box-shadow: 0 12px 40px rgba(0, 212, 255, 0.2);
    }

    .stock-symbol { font-size: 2.2em; font-weight: 900; color: white; margin-bottom: 0.5rem; }
    .stock-price { font-size: 1.8em; color: #00d4ff; font-weight: 900; margin-bottom: 0.3rem; }
    .stock-change { font-size: 1.1em; font-weight: 700; margin-bottom: 1rem; }
    .stock-change.positive { color: #10b981; }
    .stock-change.negative { color: #ef4444; }

    .signal-badge {
      display: inline-block;
      padding: 0.6rem 1.2rem;
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      border-radius: 8px;
      font-weight: 700;
      font-size: 0.85em;
      margin-bottom: 1rem;
    }

    .stock-metrics {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.8rem;
      font-size: 0.9em;
      margin: 1rem 0;
    }

    .metric {
      background: rgba(0, 212, 255, 0.1);
      padding: 0.8rem;
      border-radius: 8px;
      text-align: center;
    }

    .metric-label { font-size: 0.8em; color: #b0b8c1; }
    .metric-value { font-size: 1.2em; color: #00d4ff; font-weight: 700; }

    .ai-commentary {
      background: linear-gradient(135deg, rgba(124, 58, 237, 0.1) 0%, rgba(6, 182, 212, 0.05) 100%);
      border-left: 4px solid #7c3aed;
      border-radius: 8px;
      padding: 1rem;
      margin-top: 1rem;
      font-size: 0.85em;
      line-height: 1.6;
      color: #d1fae5;
    }

    .page { display: none; }
    .page.active { display: block; }

    /* AI Chat Widget */
    .chat-widget {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
      width: 380px;
      max-height: 600px;
      display: flex;
      flex-direction: column;
      background: linear-gradient(145deg, #1a1a40 0%, #242850 100%);
      border: 2px solid #00d4ff;
      border-radius: 15px;
      box-shadow: 0 10px 40px rgba(0, 212, 255, 0.3);
      font-family: inherit;
    }

    .chat-header {
      background: linear-gradient(135deg, #7c3aed 0%, #06b6d4 100%);
      padding: 1.5rem;
      border-radius: 13px 13px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 700;
      font-size: 1.1em;
    }

    .chat-close {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 1.3em;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.8rem;
    }

    .message {
      padding: 0.8rem 1rem;
      border-radius: 8px;
      max-width: 90%;
      word-wrap: break-word;
      font-size: 0.9em;
      line-height: 1.5;
    }

    .message.user {
      background: linear-gradient(135deg, #7c3aed 0%, #06b6d4 100%);
      color: white;
      align-self: flex-end;
      margin-left: 10%;
    }

    .message.ai {
      background: rgba(0, 212, 255, 0.1);
      border: 1px solid #00d4ff;
      color: #d1fae5;
      align-self: flex-start;
      margin-right: 10%;
    }

    .chat-input {
      padding: 1rem;
      border-top: 1px solid #333;
      display: flex;
      gap: 0.8rem;
    }

    .chat-input input {
      flex: 1;
      background: rgba(0, 212, 255, 0.1);
      border: 1px solid #00d4ff;
      color: white;
      padding: 0.8rem;
      border-radius: 8px;
      outline: none;
      font-size: 0.9em;
    }

    .chat-input button {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      border: none;
      color: white;
      padding: 0.8rem 1.2rem;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 700;
    }

    .chat-toggle {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, #7c3aed 0%, #06b6d4 100%);
      border: none;
      color: white;
      font-size: 1.5em;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      z-index: 999;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .chat-hidden { display: none !important; }

    /* Research Page */
    .research-header {
      background: linear-gradient(135deg, #7c3aed 0%, #06b6d4 100%);
      border-radius: 15px;
      padding: 2rem;
      margin-bottom: 2rem;
    }

    .research-title { font-size: 3.5em; font-weight: 900; }
    .research-subtitle { font-size: 0.95em; opacity: 0.9; margin-top: 0.5rem; }

    .research-layout {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .chart-box {
      background: rgba(30, 30, 60, 0.8);
      border: 2px solid #444;
      border-radius: 15px;
      padding: 1.5rem;
      min-height: 550px;
    }

    .chart-box h3 {
      color: #00d4ff;
      margin-bottom: 1rem;
      font-size: 1.3em;
    }

    .chart-container {
      width: 100%;
      height: 500px;
      background: rgba(20, 20, 50, 0.5);
      border-radius: 10px;
      overflow: hidden;
    }

    .chart-toggle-btn {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      padding: 0.6rem 1.2rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 700;
      margin-top: 1rem;
    }

    .stock-detail-box {
      background: rgba(30, 30, 60, 0.8);
      border: 2px solid #444;
      border-radius: 15px;
      padding: 2rem;
      margin-bottom: 2rem;
    }

    .detail-section {
      margin-bottom: 2rem;
    }

    .detail-section h3 {
      color: #00d4ff;
      font-size: 1.3em;
      margin-bottom: 1rem;
      border-bottom: 2px solid #00d4ff;
      padding-bottom: 0.5rem;
    }

    .detail-content {
      color: #b0b8c1;
      line-height: 1.8;
      font-size: 0.95em;
    }

    .detail-content strong {
      color: #10b981;
    }

    .loading { text-align: center; padding: 40px; }
    .spinner {
      border: 5px solid rgba(255,255,255,0.1);
      border-top: 5px solid #667eea;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
      .chat-widget { width: calc(100vw - 40px); }
    }
  </style>
</head>

<body>
  <!-- HEADER -->
  <div class="header">
    <div class="logo" onclick="goHome()">üìä Elite Analytics</div>
    <div class="search-bar">
      <i class="fas fa-search"></i>
      <input type="text" id="searchInput" placeholder="Search ticker..." onkeypress="if(event.key==='Enter') searchStock()">
      <button onclick="searchStock()">ANALYZE</button>
    </div>
  </div>

  <!-- HOME PAGE -->
  <div id="homePage" class="page active">
    <div class="container">
      <div style="background: linear-gradient(135deg, #7c3aed 0%, #06b6d4 100%); border-radius: 20px; padding: 3rem 2rem; text-align: center; margin-bottom: 2rem;">
        <h1 style="font-size: 2.8em; font-weight: 900;">Elite Trading Analytics</h1>
        <p style="font-size: 1.1em; opacity: 0.95;">57 Stocks + Live Prices + AI Chat + Deep Analysis</p>
      </div>

      <div class="nav-buttons">
        <button class="btn btn-primary" onclick="loadAllStocks()"><i class="fas fa-sync"></i> LOAD 57 STOCKS</button>
        <button class="btn btn-secondary" onclick="showNewsletter()"><i class="fas fa-newspaper"></i> NEWSLETTER</button>
      </div>

      <div style="display: flex; gap: 1rem; justify-content: center; margin-bottom: 2rem; flex-wrap: wrap;">
        <button class="filter-btn active" onclick="filterStocks('all')">All (57)</button>
        <button class="filter-btn" onclick="filterStocks('value')">Oversold</button>
        <button class="filter-btn" onclick="filterStocks('momentum')">Momentum</button>
        <button class="filter-btn" onclick="filterStocks('inst')">Inst Score</button>
      </div>

      <div class="stock-grid" id="stockGrid">Click LOAD 57 STOCKS to begin</div>
    </div>
  </div>

  <!-- RESEARCH PAGE -->
  <div id="researchPage" class="page">
    <div class="container">
      <div class="research-header">
        <div class="research-title" id="researchSymbol">TICKER</div>
        <div class="research-subtitle" id="researchSubtitle">Loading...</div>
      </div>

      <div class="research-layout">
        <div class="chart-box">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3>üìä Live Chart</h3>
            <button class="chart-toggle-btn" onclick="toggleChartTimeframe()">
              <span id="chartToggleLabel">Switch to 1W</span>
            </button>
          </div>
          <div class="chart-container" id="mainChart"></div>
        </div>
      </div>

      <!-- Deep Stock Analysis -->
      <div class="stock-detail-box">
        <div class="detail-section">
          <h3>üéØ Trading Edge</h3>
          <div class="detail-content" id="tradingEdge">Loading...</div>
        </div>

        <div class="detail-section">
          <h3>üíº Technical Setup</h3>
          <div class="detail-content" id="technicalSetup">Loading...</div>
        </div>

        <div class="detail-section">
          <h3>üìà AI Deep Analysis</h3>
          <div class="detail-content" id="deepAnalysis">Loading...</div>
        </div>

        <div class="detail-section">
          <h3>üé≤ 30-Day Projections</h3>
          <div class="detail-content" id="projections">Loading...</div>
        </div>

        <div class="detail-section">
          <h3>‚ö†Ô∏è Risk Management</h3>
          <div class="detail-content" id="riskMgmt">Loading...</div>
        </div>
      </div>

      <button class="btn btn-primary" onclick="goHome()" style="width: 100%;"><i class="fas fa-arrow-left"></i> BACK</button>
    </div>
  </div>

  <!-- NEWSLETTER PAGE -->
  <div id="newsletterPage" class="page">
    <div class="container">
      <div style="background: linear-gradient(135deg, #7c3aed 0%, #06b6d4 100%); border-radius: 20px; padding: 3rem 2rem; text-align: center; margin-bottom: 2rem;">
        <h1 style="font-size: 2.8em; font-weight: 900;">üì∞ Weekly Intelligence</h1>
        <p>Live Data + Macro Context + AI Predictions</p>
      </div>

      <div id="newsletterContent">Loading newsletter data...</div>

      <button class="btn btn-primary" onclick="goHome()" style="width: 100%; margin: 2rem 0;"><i class="fas fa-arrow-left"></i> BACK</button>
    </div>
  </div>

  <!-- AI CHAT WIDGET -->
  <button class="chat-toggle" id="chatToggle" onclick="toggleChat()">
    <i class="fas fa-comments"></i>
  </button>

  <div class="chat-widget chat-hidden" id="chatWidget">
    <div class="chat-header">
      <span>ü§ñ AI Trading Assistant</span>
      <button class="chat-close" onclick="toggleChat()">√ó</button>
    </div>
    <div class="chat-messages" id="chatMessages">
      <div class="message ai">
        Hi! I'm your AI trading assistant. Ask me about any stock, signals, or market analysis. How can I help?
      </div>
    </div>
    <div class="chat-input">
      <input type="text" id="chatInput" placeholder="Ask about stocks, signals..." onkeypress="if(event.key==='Enter') sendMessage()">
      <button onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
    </div>
  </div>

  <script>
    // ============ CONFIG (Uses Render Environment Variables) ============
    const API_CONFIG = {
      FRED_KEY: window.ENV?.FRED || 'USE_ENV_VAR',
      NEWS_KEY: window.ENV?.NEWS_API_KEY || 'USE_ENV_VAR',
      ALPHA_KEY: window.ENV?.ALPHAVANTAGE_KEY || 'USE_ENV_VAR',
      FINNHUB_KEY: window.ENV?.FINNHUB_KEY || 'USE_ENV_VAR',
      MASSIVE_KEY: window.ENV?.MASSIVE || 'USE_ENV_VAR',
      PERPLEXITY_KEY: window.ENV?.PERPLEXITY_API_KEY || 'USE_ENV_VAR',
      BACKEND_URL: window.ENV?.FRONTEND_URL || 'https://elite-trading-api.onrender.com',
      PORT: window.ENV?.PORT || 3000
    };

    let allStocks = [];
    let currentChartTimeframe = 'D'; // D = 1D, W = 1W

    window.addEventListener('load', async () => {
      await loadStocksFromCSV();
      loadAllStocks();
    });

    // ============ LOAD CSV ============
    async function loadStocksFromCSV() {
      const csvFiles = [
        '/2025-11-20-watchlist.csv',
        '/2025-11-20-watchlist-Priority.csv',
        '/2025-11-20-watchlist-GN1.csv',
        '/2025-11-20-watchlist-GN2.csv'
      ];

      for (let csvFile of csvFiles) {
        try {
          const res = await fetch(csvFile);
          if (res.ok) {
            const csv = await res.text();
            const rows = parseCSV(csv);
            allStocks.push(...rows);
          }
        } catch (e) {
          console.log(`CSV not found: ${csvFile}`);
        }
      }

      if (allStocks.length === 0) {
        allStocks = generateFallbackStocks();
      }
    }

    function parseCSV(csv) {
      const lines = csv.trim().split('\n');
      if (lines.length < 2) return [];
      const headers = lines[0].split(',').map(h => h.trim());
      const rows = [];

      for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(',').map(v => v.trim());
        if (values[0]) {
          const row = {};
          headers.forEach((header, idx) => {
            row[header] = values[idx] || '';
          });
          rows.push(row);
        }
      }
      return rows;
    }

    function generateFallbackStocks() {
      return [
        {Symbol:'NVDA','Last':929.53,Change:2.3,RSIWIlder:70,'Regime Detection':82,'Inst 33':85},
        {Symbol:'TSLA','Last':342.80,Change:-2.3,RSIWIlder:42,'Regime Detection':50,'Inst 33':60},
        {Symbol:'MU','Last':201.37,Change:-10.87,RSIWIlder:41,'Regime Detection':75,'Inst 33':53},
        {Symbol:'SE','Last':130.99,Change:-8.74,RSIWIlder:28,'Regime Detection':51,'Inst 33':38},
      ];
    }

    // ============ AI COMMENTARY ============
    function getAICommentary(stock) {
      const price = parseFloat(stock['Last'] || 0);
      const change = parseFloat(stock.Change || 0);
      const rsi = parseFloat(stock.RSIWIlder || 0);
      const regime = parseFloat(stock['Regime Detection'] || 0);
      const inst = parseFloat(stock['Inst 33'] || 0);

      let edge = '', trade = '', risk = '';

      // Edge detection
      if (change < -8 && rsi < 35 && inst > 50) {
        edge = `EXTREME OVERSOLD -${Math.abs(change).toFixed(1)}% with institutional accumulation. Mean reversion setup with high conviction.`;
        trade = `Scale in 3 tranches: 1/3 now, 1/3 at -5% dips, 1/3 at major support. Classic turnaround candidate. 15-25% upside potential 7-14 days.`;
        risk = `Cycle downturn could extend. Hard stops at -8%. Max 2% portfolio allocation. Monitor volume for reversal confirmation.`;
      } else if (change > 10 && rsi > 70) {
        edge = `STRONG BREAKOUT +${change.toFixed(1)}% with overbought conditions. Momentum continuation likely.`;
        trade = `Add on pullbacks to 20MA. Sell 30% on +25% rallies. Use calls for leverage. Trail stops above swing lows.`;
        risk = `Profit taking imminent. Watch for exhaustion. Overbought can persist. Exit first sign of weakness.`;
      } else if (change < -2 && rsi > 40 && rsi < 60) {
        edge = `Pullback on weakness -${Math.abs(change).toFixed(1)}%. Institutional interest remains. Consolidation before next leg.`;
        trade = `Buy dips on support. Scale into 50% position. Wait for RSI inflection. Regime ${regime > 60 ? 'remains bullish' : 'turning bearish'}.`;
        risk = `Could test deeper lows if regime breaks. Watch key support at ${(price * 0.95).toFixed(2)}. Use 2% stops.`;
      } else {
        edge = `Consolidation pattern. Setup forming. Technical bias ${change > 0 ? 'remains bullish' : 'neutral'}.`;
        trade = `Monitor for breakout. Range-bound trading. Wait for clear direction. 3-5 day patience required.`;
        risk = `Choppy action expected. Avoid position until clarity. Tight stops if trading ranges.`;
      }

      return { edge, trade, risk };
    }

    // ============ RENDER STOCKS ============
    function loadAllStocks() {
      renderStocks('all');
    }

    function renderStocks(filter) {
      const filtered = allStocks.filter(s => {
        const change = parseFloat(s.Change || 0);
        if (filter === 'value') return change < -2;
        if (filter === 'momentum') return change > 3;
        if (filter === 'inst') return parseFloat(s['Inst 33'] || 0) > 60;
        return true;
      });

      document.getElementById('stockGrid').innerHTML = filtered.slice(0, 57).map(s => {
        const symbol = s.Symbol || s['Symbol.1'];
        const price = parseFloat(s['Last'] || s.Price || 0);
        const change = parseFloat(s.Change || 0);
        const rsi = parseFloat(s.RSIWIlder || 0);
        const regime = parseFloat(s['Regime Detection'] || 0);
        const ai = getAICommentary(s);

        const signal = change < -8 ? 'STRONG BUY' : change < -2 ? 'BUY' : change > 10 ? 'SELL' : 'HOLD';

        return `
          <div class="stock-card" onclick="researchStock('${symbol}')">
            <div class="stock-symbol">${symbol}</div>
            <div class="stock-price">$${price.toFixed(2)}</div>
            <div class="stock-change ${change >= 0 ? 'positive' : 'negative'}">
              ${change >= 0 ? '‚ñ≤' : '‚ñº'} ${Math.abs(change).toFixed(2)}%
            </div>
            <span class="signal-badge">${signal}</span>
            <div class="stock-metrics">
              <div class="metric"><div class="metric-label">RSI</div><div class="metric-value">${rsi.toFixed(0)}</div></div>
              <div class="metric"><div class="metric-label">Regime</div><div class="metric-value">${regime.toFixed(0)}%</div></div>
            </div>
            <div class="ai-commentary">
              <strong>üéØ ${ai.edge.substring(0, 80)}...</strong>
            </div>
          </div>
        `;
      }).join('');
    }

    function filterStocks(type) {
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      event.target.classList.add('active');
      renderStocks(type);
    }

    // ============ RESEARCH PAGE ============
    async function researchStock(ticker) {
      hideAllPages();
      document.getElementById('researchPage').classList.add('active');

      const stock = allStocks.find(s => (s.Symbol || s['Symbol.1']) === ticker);
      if (!stock) return;

      const price = parseFloat(stock['Last'] || 0);
      const change = parseFloat(stock.Change || 0);
      const rsi = parseFloat(stock.RSIWIlder || 0);
      const ai = getAICommentary(stock);

      document.getElementById('researchSymbol').textContent = ticker;
      document.getElementById('researchSubtitle').textContent = `$${price.toFixed(2)} (${change >= 0 ? '+' : ''}${change.toFixed(2)}%)`;

      // Trading Edge
      document.getElementById('tradingEdge').innerHTML = `
        <strong>üéØ ${ai.edge}</strong>
      `;

      // Technical Setup
      document.getElementById('technicalSetup').innerHTML = `
        <strong>RSI:</strong> ${rsi.toFixed(0)} (${rsi < 30 ? 'Oversold' : rsi > 70 ? 'Overbought' : 'Neutral'})<br>
        <strong>Regime:</strong> ${parseFloat(stock['Regime Detection'] || 0).toFixed(0)}% (${parseFloat(stock['Regime Detection']) > 60 ? 'Trending Up' : 'Weak'})<br>
        <strong>Inst Score:</strong> ${parseFloat(stock['Inst 33'] || 0).toFixed(0)} (${parseFloat(stock['Inst 33']) > 60 ? 'Strong Accumulation' : 'Neutral'})<br>
        <strong>Support:</strong> $${(price * 0.95).toFixed(2)} | <strong>Resistance:</strong> $${(price * 1.10).toFixed(2)}
      `;

      // Deep Analysis
      document.getElementById('deepAnalysis').innerHTML = `
        <strong>üíº ${ai.trade}</strong>
      `;

      // 30-Day Projections
      const vol = Math.abs(change) / 100 + 0.15;
      const mc10 = (price * (1 - vol * 1.28)).toFixed(2);
      const mc50 = price.toFixed(2);
      const mc90 = (price * (1 + vol * 1.28)).toFixed(2);

      document.getElementById('projections').innerHTML = `
        <strong>10th percentile (Downside):</strong> $${mc10}<br>
        <strong>50th percentile (Expected):</strong> $${mc50}<br>
        <strong>90th percentile (Upside):</strong> $${mc90}<br>
        <strong>Probability of +10% move:</strong> ${(Math.min(100, 30 + Math.abs(change) * 5)).toFixed(0)}%
      `;

      // Risk Management
      document.getElementById('riskMgmt').innerHTML = `
        <strong>‚ö†Ô∏è ${ai.risk}</strong>
      `;

      // Render chart
      renderChart(ticker);
    }

    function renderChart(ticker) {
      document.getElementById('mainChart').innerHTML = '';
      document.getElementById('chartToggleLabel').textContent = currentChartTimeframe === 'D' ? 'Switch to 1W' : 'Switch to 1D';

      new TradingView.widget({
        "container_id": "mainChart",
        "width": "100%",
        "height": "100%",
        "symbol": ticker,
        "interval": currentChartTimeframe,
        "timezone": "America/New_York",
        "theme": "dark",
        "style": "1",
        "studies": ["BB@tv-basicstudies", "MACD@tv-basicstudies", "RSI@tv-basicstudies"]
      });
    }

    function toggleChartTimeframe() {
      currentChartTimeframe = currentChartTimeframe === 'D' ? 'W' : 'D';
      const ticker = document.getElementById('researchSymbol').textContent;
      renderChart(ticker);
    }

    // ============ NEWSLETTER ============
    function showNewsletter() {
      hideAllPages();
      document.getElementById('newsletterPage').classList.add('active');
      populateNewsletter();
    }

    function populateNewsletter() {
      const valueStocks = allStocks.filter(s => parseFloat(s.Change || 0) < -2).slice(0, 5);
      const momentumStocks = allStocks.filter(s => parseFloat(s.Change || 0) > 3).slice(0, 5);

      let html = `
        <div style="background: rgba(0,212,255,0.05); border: 2px solid #00d4ff; border-radius: 15px; padding: 2rem; margin-bottom: 2rem;">
          <h3 style="color: #10b981; font-size: 1.5em; margin-bottom: 1rem;">üìä VALUE PLAYS - OVERSOLD</h3>
          <table style="width: 100%; border-collapse: collapse; color: #b0b8c1;">
            <tr style="background: rgba(124,58,237,0.3); color: #00d4ff;">
              <th style="padding: 0.8rem; text-align: left;">Ticker</th>
              <th style="padding: 0.8rem;">Price</th>
              <th style="padding: 0.8rem;">Change</th>
              <th style="padding: 0.8rem;">Signal</th>
            </tr>
            ${valueStocks.map(s => `
              <tr style="border-bottom: 1px solid #333;" onclick="researchStock('${s.Symbol}'); researchStock = researchStock;">
                <td style="padding: 0.8rem;"><strong>${s.Symbol}</strong></td>
                <td style="padding: 0.8rem; text-align: center;">$${parseFloat(s['Last'] || 0).toFixed(2)}</td>
                <td style="padding: 0.8rem; text-align: center; color: #ef4444;">${(parseFloat(s.Change) || 0).toFixed(2)}%</td>
                <td style="padding: 0.8rem; text-align: center; color: #10b981;"><strong>BUY</strong></td>
              </tr>
            `).join('')}
          </table>
        </div>

        <div style="background: rgba(0,212,255,0.05); border: 2px solid #00d4ff; border-radius: 15px; padding: 2rem; margin-bottom: 2rem;">
          <h3 style="color: #10b981; font-size: 1.5em; margin-bottom: 1rem;">üöÄ MOMENTUM PLAYS</h3>
          <table style="width: 100%; border-collapse: collapse; color: #b0b8c1;">
            <tr style="background: rgba(124,58,237,0.3); color: #00d4ff;">
              <th style="padding: 0.8rem; text-align: left;">Ticker</th>
              <th style="padding: 0.8rem;">Price</th>
              <th style="padding: 0.8rem;">Change</th>
              <th style="padding: 0.8rem;">Signal</th>
            </tr>
            ${momentumStocks.map(s => `
              <tr style="border-bottom: 1px solid #333;">
                <td style="padding: 0.8rem;"><strong>${s.Symbol}</strong></td>
                <td style="padding: 0.8rem; text-align: center;">$${parseFloat(s['Last'] || 0).toFixed(2)}</td>
                <td style="padding: 0.8rem; text-align: center; color: #10b981;">+${(parseFloat(s.Change) || 0).toFixed(2)}%</td>
                <td style="padding: 0.8rem; text-align: center; color: #10b981;"><strong>HOLD/SELL</strong></td>
              </tr>
            `).join('')}
          </table>
        </div>
      `;

      document.getElementById('newsletterContent').innerHTML = html;
    }

    // ============ AI CHAT ============
    let chatHistory = [];

    function toggleChat() {
      document.getElementById('chatWidget').classList.toggle('chat-hidden');
    }

    async function sendMessage() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      if (!message) return;

      // Add user message
      chatHistory.push({ role: 'user', content: message });
      addMessageToChat('user', message);
      input.value = '';

      // Get AI response
      const response = await getAIResponse(message);
      chatHistory.push({ role: 'ai', content: response });
      addMessageToChat('ai', response);
    }

    function addMessageToChat(role, message) {
      const chatMessages = document.getElementById('chatMessages');
      const msgDiv = document.createElement('div');
      msgDiv.className = `message ${role}`;
      msgDiv.textContent = message;
      chatMessages.appendChild(msgDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    async function getAIResponse(userMessage) {
      try {
        // Call to Perplexity API via backend
        const res = await fetch(`${API_CONFIG.BACKEND_URL}/api/ai-analyze`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            question: userMessage,
            stocks: allStocks.slice(0, 10),
            history: chatHistory
          })
        });

        if (res.ok) {
          const data = await res.json();
          return data.response || 'I could not process that request.';
        } else {
          return 'AI service temporarily unavailable. Please check backend connection.';
        }
      } catch (e) {
        return `Error: ${e.message}. Ensure backend is running at ${API_CONFIG.BACKEND_URL}`;
      }
    }

    // ============ NAVIGATION ============
    function goHome() {
      hideAllPages();
      document.getElementById('homePage').classList.add('active');
      loadAllStocks();
    }

    function hideAllPages() {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    }

    function searchStock() {
      const ticker = document.getElementById('searchInput').value.toUpperCase().trim();
      if (ticker) {
        researchStock(ticker);
        document.getElementById('searchInput').value = '';
      }
    }
  </script>
</body>
</html>
