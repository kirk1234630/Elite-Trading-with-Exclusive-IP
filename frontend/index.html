<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elite Trading Analytics - Full Suite</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            min-height: 100vh;
            color: #e0e0e0;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .market-story-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 40px 20px;
            text-align: center;
            color: white;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .story-title {
            font-size: 2.8em;
            font-weight: 700;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .story-narrative {
            max-width: 1000px;
            margin: 0 auto;
            font-size: 1.3em;
            line-height: 1.8;
            padding: 30px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        /* Search Section */
        .search-section {
            max-width: 900px;
            margin: 30px auto;
        }

        .search-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .search-input {
            flex: 1;
            padding: 20px 28px;
            font-size: 1.3em;
            background: rgba(255,255,255,0.12);
            border: 2px solid rgba(255,255,255,0.25);
            border-radius: 15px;
            color: white;
            outline: none;
            transition: all 0.3s;
        }

        .search-input:focus {
            border-color: #667eea;
            background: rgba(255,255,255,0.18);
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.4);
        }

        .analyze-btn {
            padding: 20px 45px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 15px;
            color: white;
            font-size: 1.3em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .analyze-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 16px 32px;
            border: none;
            border-radius: 12px;
            color: white;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.05em;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(0,0,0,0.4);
        }

        .btn-scanner {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .btn-brief {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        /* Detailed Analysis View */
        .detailed-analysis {
            background: linear-gradient(145deg, #2d2d44 0%, #1f1f2e 100%);
            border-radius: 25px;
            padding: 40px;
            margin: 30px 0;
            box-shadow: 0 15px 35px rgba(0,0,0,0.4);
        }

        .analysis-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(102, 126, 234, 0.3);
        }

        .ticker-display {
            font-size: 3em;
            font-weight: 700;
            color: #fff;
        }

        .price-display {
            text-align: right;
        }

        .current-price {
            font-size: 2.5em;
            font-weight: 700;
        }

        .after-hours {
            font-size: 1.2em;
            color: #10b981;
            margin-top: 5px;
        }

        /* TradingView Chart Container */
        .chart-container {
            background: #1a1a2e;
            border-radius: 15px;
            padding: 20px;
            margin: 30px 0;
            min-height: 500px;
        }

        /* Indicators Grid */
        .indicators-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .indicator-card {
            background: linear-gradient(145deg, rgba(102, 126, 234, 0.12), rgba(118, 75, 162, 0.08));
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 15px;
            padding: 25px;
            transition: all 0.3s;
        }

        .indicator-card:hover {
            transform: translateY(-5px);
            border-color: #667eea;
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.25);
        }

        .indicator-label {
            font-size: 0.95em;
            color: #999;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .indicator-value {
            font-size: 1.8em;
            font-weight: 700;
            color: #fff;
        }

        .indicator-subtext {
            font-size: 0.9em;
            color: #aaa;
            margin-top: 8px;
        }

        /* Z-Scores Section */
        .z-scores-section {
            background: rgba(16, 185, 129, 0.08);
            border-left: 4px solid #10b981;
            border-radius: 12px;
            padding: 25px;
            margin: 25px 0;
        }

        .z-scores-title {
            font-size: 1.5em;
            color: #10b981;
            margin-bottom: 20px;
            font-weight: 700;
        }

        .z-scores-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
        }

        .z-score-item {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        /* Ranges Display */
        .ranges-section {
            background: rgba(102, 126, 234, 0.08);
            border-left: 4px solid #667eea;
            border-radius: 12px;
            padding: 25px;
            margin: 25px 0;
        }

        .ranges-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        .range-box {
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .range-label {
            font-size: 1.1em;
            color: #667eea;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .range-values {
            font-size: 1.3em;
            color: #fff;
        }

        /* Scalping Strategy */
        .scalping-strategy {
            background: rgba(239, 68, 68, 0.08);
            border-left: 4px solid #ef4444;
            border-radius: 12px;
            padding: 25px;
            margin: 25px 0;
        }

        .scalping-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        .scalping-box {
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        /* Performance Metrics */
        .performance-metrics {
            background: rgba(245, 158, 11, 0.08);
            border-left: 4px solid #f59e0b;
            border-radius: 12px;
            padding: 25px;
            margin: 25px 0;
        }

        /* Composite Scores */
        .composite-scores {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin: 30px 0;
        }

        .score-card {
            background: linear-gradient(145deg, rgba(16, 185, 129, 0.15), rgba(5, 150, 105, 0.08));
            border: 2px solid rgba(16, 185, 129, 0.3);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
        }

        .score-value {
            font-size: 3.5em;
            font-weight: 700;
            color: #10b981;
        }

        .score-label {
            font-size: 1.2em;
            color: #aaa;
            margin-top: 10px;
        }

        /* Top Plays Grid */
        .plays-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }

        .play-card {
            background: linear-gradient(145deg, #2d2d44 0%, #1f1f2e 100%);
            border-radius: 20px;
            padding: 30px;
            cursor: pointer;
            transition: all 0.4s ease;
            border: 2px solid transparent;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }

        .play-card:hover {
            transform: translateY(-8px);
            border-color: #667eea;
            box-shadow: 0 20px 45px rgba(102, 126, 234, 0.4);
        }

        .play-ticker {
            font-size: 2.2em;
            font-weight: 700;
            color: #fff;
            margin-bottom: 10px;
        }

        .play-story-name {
            font-size: 1.4em;
            color: #667eea;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .play-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 15px 0;
        }

        .play-metric {
            background: rgba(102, 126, 234, 0.12);
            padding: 15px;
            border-radius: 12px;
        }

        .metric-label {
            font-size: 0.9em;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-value {
            font-size: 1.4em;
            font-weight: 700;
            color: #fff;
            margin-top: 5px;
        }

        .play-signal {
            background: rgba(16, 185, 129, 0.12);
            border-left: 4px solid #10b981;
            padding: 18px;
            border-radius: 10px;
            margin: 18px 0;
        }

        /* Loading States */
        .loading {
            text-align: center;
            padding: 80px 20px;
        }

        .spinner {
            border: 5px solid rgba(255, 255, 255, 0.1);
            border-top: 5px solid #667eea;
            border-radius: 50%;
            width: 70px;
            height: 70px;
            animation: spin 1s linear infinite;
            margin: 0 auto 25px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .story-title {
                font-size: 2em;
            }
            
            .ranges-grid,
            .scalping-grid,
            .composite-scores {
                grid-template-columns: 1fr;
            }
            
            .plays-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="market-story-header">
            <h1 class="story-title">üìä Elite Trading Analytics Platform</h1>
            <div class="story-narrative" id="marketNarrative">
                "Loading proprietary ThinkScript indicators and institutional flow data..."
            </div>
        </div>

        <div class="search-section">
            <div class="search-bar">
                <input 
                    type="text" 
                    id="tickerInput" 
                    class="search-input"
                    placeholder="Enter ticker (e.g., NVDA, TSLA, AAPL...)" 
                    onkeypress="if(event.key==='Enter') analyzeStock()"
                />
                <button onclick="analyzeStock()" class="analyze-btn">
                    üîç DEEP ANALYSIS
                </button>
            </div>
            
            <div class="action-buttons">
                <button onclick="runFullScanner()" class="btn btn-scanner">
                    üéØ SCAN MARKETS
                </button>
                <button onclick="viewNewsBrief()" class="btn btn-brief">
                    üì∞ MARKET BRIEF
                </button>
            </div>
        </div>

        <div id="detailedView" class="hidden"></div>
        
        <div class="plays-grid" id="playsGrid">
            <div class="loading">
                <div class="spinner"></div>
                <p style="font-size: 1.2em;">Analyzing top opportunities with proprietary indicators...</p>
            </div>
        </div>
    </div>

    <!-- TradingView Widget Script -->
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>

    <script>
        // API Configuration - Multi-source with fallback
        const API_ENDPOINTS = {
            alphavantage: 'https://elite-trading-with-exclusive-ip.onrender.com/api',
            yahoo: 'https://query1.finance.yahoo.com',
            cors_proxy: 'https://api.allorigins.win/raw?url='
        };

        // Your proprietary watchlist with enhanced data
        const WATCHLIST_DATA = {
            'SNDK': {
                cusum: -0.84,
                regimeDetection: 149.2,
                instScore: 53,
                volatility: 43.0,
                momentum: -62.3,
                strategy: 'ACCUMULATE',
                reasoning: 'Extreme Bear Deviation (-0.84 CUSUM) meeting high institutional accumulation (Inst: 53). Volatility regime expansion signals explosive reversal setup.'
            },
            'OKLO': {
                cusum: -1.68,
                regimeDetection: 113.4,
                instScore: 38,
                volatility: 63.0,
                momentum: -58.7,
                strategy: 'LONG',
                reasoning: 'Nuclear energy deep value play. CUSUM -1.68 with regime detection 113.4% shows strong mean reversion probability with institutional backing.'
            },
            'IONQ': {
                cusum: -2.18,
                regimeDetection: 97.4,
                instScore: 41,
                volatility: 98.0,
                momentum: -71.2,
                strategy: 'ACCUMULATE',
                reasoning: 'Quantum computing leader at deepest CUSUM (-2.18). Extreme oversold with institutional interest = asymmetric risk/reward setup.'
            },
            'MU': {
                cusum: -2.47,
                regimeDetection: 75.6,
                instScore: 53,
                volatility: 60.0,
                momentum: -54.9,
                strategy: 'STRONG BUY',
                reasoning: 'Maximum Bear Deviation (-2.47 CUSUM) in memory chip giant. High Inst Score (53) + volatility contraction = bullish breakout imminent.'
            }
        };

        // Advanced Technical Calculations
        class TechnicalAnalytics {
            // SuperTrend Calculation
            static calculateSuperTrend(prices, period = 10, multiplier = 3) {
                const atr = this.calculateATR(prices, period);
                const hl2 = prices.map((p, i) => (p.high + p.low) / 2);
                
                const basicUpperBand = hl2.map((h, i) => h + (multiplier * atr[i]));
                const basicLowerBand = hl2.map((h, i) => h - (multiplier * atr[i]));
                
                const trend = prices[prices.length - 1].close > basicLowerBand[basicLowerBand.length - 1] ? 'UP' : 'DOWN';
                const value = trend === 'UP' ? basicLowerBand[basicLowerBand.length - 1] : basicUpperBand[basicUpperBand.length - 1];
                
                return { trend, value: value.toFixed(2) };
            }

            // ATR for SuperTrend
            static calculateATR(prices, period = 14) {
                const tr = prices.map((p, i) => {
                    if (i === 0) return p.high - p.low;
                    const hl = p.high - p.low;
                    const hc = Math.abs(p.high - prices[i-1].close);
                    const lc = Math.abs(p.low - prices[i-1].close);
                    return Math.max(hl, hc, lc);
                });
                
                return tr.map((_, i) => {
                    const slice = tr.slice(Math.max(0, i - period + 1), i + 1);
                    return slice.reduce((a, b) => a + b, 0) / slice.length;
                });
            }

            // Bull/Bear Power
            static calculateBullBearPower(prices, period = 13) {
                const ema = this.calculateEMA(prices.map(p => p.close), period);
                const lastEMA = ema[ema.length - 1];
                const lastPrice = prices[prices.length - 1];
                
                const bullPower = ((lastPrice.high - lastEMA) / lastEMA * 100).toFixed(2);
                const bearPower = ((lastPrice.low - lastEMA) / lastEMA * 100).toFixed(2);
                
                return { bullPower, bearPower };
            }

            // EMA Calculation
            static calculateEMA(data, period) {
                const k = 2 / (period + 1);
                const ema = [data[0]];
                
                for (let i = 1; i < data.length; i++) {
                    ema.push(data[i] * k + ema[i - 1] * (1 - k));
                }
                
                return ema;
            }

            // Z-Score Calculator
            static calculateZScore(value, data) {
                const mean = data.reduce((a, b) => a + b, 0) / data.length;
                const std = Math.sqrt(data.reduce((sq, n) => sq + Math.pow(n - mean, 2), 0) / data.length);
                return ((value - mean) / std).toFixed(2);
            }

            // VWAP Z-Score
            static calculateVWAPZScore(prices) {
                const vwap = prices.reduce((sum, p, i) => {
                    return sum + (p.close * p.volume);
                }, 0) / prices.reduce((sum, p) => sum + p.volume, 0);
                
                const currentPrice = prices[prices.length - 1].close;
                const priceArray = prices.map(p => p.close);
                
                return this.calculateZScore(currentPrice, priceArray);
            }

            // Volume Z-Score
            static calculateVolumeZScore(prices) {
                const volumes = prices.map(p => p.volume);
                const currentVol = volumes[volumes.length - 1];
                return this.calculateZScore(currentVol, volumes);
            }

            // OBV (On-Balance Volume)
            static calculateOBV(prices) {
                let obv = 0;
                const obvArray = prices.map((p, i) => {
                    if (i === 0) return p.volume;
                    if (p.close > prices[i-1].close) obv += p.volume;
                    else if (p.close < prices[i-1].close) obv -= p.volume;
                    return obv;
                });
                
                return this.calculateZScore(obvArray[obvArray.length - 1], obvArray);
            }

            // RSI Z-Score
            static calculateRSIZScore(prices, period = 14) {
                const rsi = this.calculateRSI(prices.map(p => p.close), period);
                const currentRSI = rsi[rsi.length - 1];
                return this.calculateZScore(currentRSI, rsi);
            }

            // RSI Calculation
            static calculateRSI(data, period = 14) {
                const changes = data.slice(1).map((price, i) => price - data[i]);
                const gains = changes.map(change => change > 0 ? change : 0);
                const losses = changes.map(change => change < 0 ? -change : 0);
                
                const avgGain = gains.slice(0, period).reduce((a, b) => a + b, 0) / period;
                const avgLoss = losses.slice(0, period).reduce((a, b) => a + b, 0) / period;
                
                const rs = avgGain / (avgLoss || 0.01);
                const rsi = 100 - (100 / (1 + rs));
                
                return [rsi];
            }

            // MACD Z-Score
            static calculateMACDZScore(prices) {
                const closes = prices.map(p => p.close);
                const ema12 = this.calculateEMA(closes, 12);
                const ema26 = this.calculateEMA(closes, 26);
                const macdLine = ema12.map((val, i) => val - ema26[i]);
                const currentMACD = macdLine[macdLine.length - 1];
                
                return this.calculateZScore(currentMACD, macdLine);
            }

            // CMF (Chaikin Money Flow) Z-Score
            static calculateCMFZScore(prices, period = 20) {
                const mfv = prices.map(p => {
                    const mfm = ((p.close - p.low) - (p.high - p.close)) / (p.high - p.low || 1);
                    return mfm * p.volume;
                });
                
                const cmfArray = mfv.map((_, i) => {
                    const slice = mfv.slice(Math.max(0, i - period + 1), i + 1);
                    const volSlice = prices.slice(Math.max(0, i - period + 1), i + 1).map(p => p.volume);
                    return slice.reduce((a, b) => a + b, 0) / volSlice.reduce((a, b) => a + b, 0);
                });
                
                return this.calculateZScore(cmfArray[cmfArray.length - 1], cmfArray);
            }

            // Projected Ranges (Monte Carlo simulation)
            static calculateProjectedRanges(currentPrice, volatility, days) {
                const dailyVol = volatility / Math.sqrt(252);
                const z_score_95 = 1.96; // 95% confidence
                
                const drift = -0.5 * Math.pow(dailyVol, 2);
                const diffusion = dailyVol * Math.sqrt(days);
                
                const upperRange = currentPrice * Math.exp(drift * days + z_score_95 * diffusion);
                const lowerRange = currentPrice * Math.exp(drift * days - z_score_95 * diffusion);
                
                return {
                    upper: upperRange.toFixed(2),
                    lower: lowerRange.toFixed(2),
                    expected: currentPrice.toFixed(2)
                };
            }

            // Sharpe Ratio (annualized)
            static calculateSharpeRatio(returns, riskFreeRate = 0.04) {
                const avgReturn = returns.reduce((a, b) => a + b, 0) / returns.length;
                const std = Math.sqrt(returns.reduce((sq, r) => sq + Math.pow(r - avgReturn, 2), 0) / returns.length);
                const annualizedReturn = avgReturn * 252;
                const annualizedVol = std * Math.sqrt(252);
                return ((annualizedReturn - riskFreeRate) / annualizedVol).toFixed(2);
            }

            // Win Rate
            static calculateWinRate(returns) {
                const wins = returns.filter(r => r > 0).length;
                return ((wins / returns.length) * 100).toFixed(1);
            }

            // Max Drawdown
            static calculateMaxDrawdown(prices) {
                let maxPrice = prices[0];
                let maxDrawdown = 0;
                
                prices.forEach(price => {
                    if (price > maxPrice) maxPrice = price;
                    const drawdown = ((maxPrice - price) / maxPrice) * 100;
                    if (drawdown > maxDrawdown) maxDrawdown = drawdown;
                });
                
                return maxDrawdown.toFixed(2);
            }

            // Momentum (last 10 bars)
            static calculateMomentum(prices) {
                const last10 = prices.slice(-10);
                const upBars = last10.filter((p, i) => i > 0 && p.close > last10[i-1].close).length;
                return ((upBars / 9) * 100).toFixed(1);
            }

            // Altman Z-Score (M-Score proxy for financial health)
            static calculateAltmanZScore(marketCap, revenue, ebitda, totalAssets, currentAssets, currentLiabilities) {
                // Simplified Z-Score for public companies
                const workingCapital = currentAssets - currentLiabilities;
                const X1 = workingCapital / totalAssets;
                const X2 = (revenue * 0.2) / totalAssets; // Retained earnings proxy
                const X3 = ebitda / totalAssets;
                const X4 = marketCap / (totalAssets - currentAssets);
                const X5 = revenue / totalAssets;
                
                const zScore = (1.2 * X1) + (1.4 * X2) + (3.3 * X3) + (0.6 * X4) + (1.0 * X5);
                
                return {
                    score: zScore.toFixed(2),
                    rating: zScore > 2.99 ? 'SAFE' : zScore > 1.81 ? 'GREY' : 'DISTRESS'
                };
            }
        }

        // Fetch data from Yahoo Finance
        async function fetchYahooData(ticker) {
            try {
                const chartUrl = `${API_ENDPOINTS.yahoo}/v8/finance/chart/${ticker}?range=1mo&interval=1d&includePrePost=true`;
                const quoteUrl = `${API_ENDPOINTS.yahoo}/v7/finance/quote?symbols=${ticker}`;
                
                // Use CORS proxy for browser access
                const chartRes = await fetch(API_ENDPOINTS.cors_proxy + encodeURIComponent(chartUrl));
                const quoteRes = await fetch(API_ENDPOINTS.cors_proxy + encodeURIComponent(quoteUrl));
                
                const chartData = await chartRes.json();
                const quoteData = await quoteRes.json();
                
                return {
                    chart: chartData.chart.result[0],
                    quote: quoteData.quoteResponse.result[0],
                    success: true
                };
            } catch (error) {
                console.error('Yahoo Finance error:', error);
                return { success: false };
            }
        }

        // Build price array from chart data
        function buildPriceArray(chartData) {
            const timestamps = chartData.timestamp;
            const indicators = chartData.indicators.quote[0];
            
            return timestamps.map((t, i) => ({
                timestamp: t,
                open: indicators.open[i],
                high: indicators.high[i],
                low: indicators.low[i],
                close: indicators.close[i],
                volume: indicators.volume[i]
            })).filter(p => p.close !== null);
        }

        // Main analysis function
        async function analyzeStock() {
            const ticker = document.getElementById('tickerInput').value.trim().toUpperCase();
            if (!ticker) return alert('Please enter a ticker symbol');
            
            document.getElementById('playsGrid').classList.add('hidden');
            document.getElementById('detailedView').classList.remove('hidden');
            document.getElementById('detailedView').innerHTML = '<div class="loading"><div class="spinner"></div><p style="font-size: 1.3em;">Running deep analysis on ' + ticker + '...</p></div>';
            
            try {
                // Fetch Yahoo Finance data
                const yahooData = await fetchYahooData(ticker);
                
                if (!yahooData.success) {
                    throw new Error('Unable to fetch data');
                }
                
                const quote = yahooData.quote;
                const chartData = yahooData.chart;
                const prices = buildPriceArray(chartData);
                
                // Calculate all indicators
                const currentPrice = quote.regularMarketPrice;
                const afterHoursPrice = quote.postMarketPrice || quote.preMarketPrice;
                const afterHoursChange = afterHoursPrice ? ((afterHoursPrice - currentPrice) / currentPrice * 100).toFixed(2) : null;
                
                const superTrend = TechnicalAnalytics.calculateSuperTrend(prices);
                const bullBearPower = TechnicalAnalytics.calculateBullBearPower(prices);
                const vwapZ = TechnicalAnalytics.calculateVWAPZScore(prices);
                const volZ = TechnicalAnalytics.calculateVolumeZScore(prices);
                const obvZ = TechnicalAnalytics.calculateOBV(prices);
                const rsiZ = TechnicalAnalytics.calculateRSIZScore(prices);
                const macdZ = TechnicalAnalytics.calculateMACDZScore(prices);
                const cmfZ = TechnicalAnalytics.calculateCMFZScore(prices);
                
                // Projected ranges
                const volatility = (quote.fiftyTwoWeekHigh - quote.fiftyTwoWeekLow) / quote.fiftyTwoWeekLow;
                const range5d = TechnicalAnalytics.calculateProjectedRanges(currentPrice, volatility, 5);
                const range10d = TechnicalAnalytics.calculateProjectedRanges(currentPrice, volatility, 10);
                const range30d = TechnicalAnalytics.calculateProjectedRanges(currentPrice, volatility, 30);
                
                // Returns for performance metrics
                const returns = prices.slice(1).map((p, i) => (p.close - prices[i].close) / prices[i].close);
                const sharpe = TechnicalAnalytics.calculateSharpeRatio(returns);
                const winRate = TechnicalAnalytics.calculateWinRate(returns);
                const maxDD = TechnicalAnalytics.calculateMaxDrawdown(prices.map(p => p.close));
                const momentum = TechnicalAnalytics.calculateMomentum(prices);
                
                // Entry/Exit/Stop prices for scalping
                const atr = TechnicalAnalytics.calculateATR(prices, 14);
                const currentATR = atr[atr.length - 1];
                const entryPrice = currentPrice;
                const stopLoss = (entryPrice - (currentATR * 1.5)).toFixed(2);
                const takeProfit = (entryPrice + (currentATR * 2.5)).toFixed(2);
                
                // Composite scores
                const factorScore = (
                    (parseFloat(vwapZ) * 0.2) +
                    (parseFloat(rsiZ) * 0.15) +
                    (parseFloat(macdZ) * 0.15) +
                    (parseFloat(obvZ) * 0.15) +
                    (parseFloat(cmfZ) * 0.15) +
                    (parseFloat(volZ) * 0.2)
                ).toFixed(2);
                
                const compositeScore = (
                    (parseFloat(sharpe) * 30) +
                    (parseFloat(winRate) * 0.5) +
                    (100 - parseFloat(maxDD)) +
                    (parseFloat(factorScore) * 10)
                ).toFixed(1);
                
                // M-Score (Altman Z-Score approximation)
                const mScore = TechnicalAnalytics.calculateAltmanZScore(
                    quote.marketCap || 1e9,
                    quote.marketCap / 10, // revenue proxy
                    quote.marketCap / 15, // ebitda proxy
                    quote.marketCap / 2,  // total assets proxy
                    quote.marketCap / 5,  // current assets proxy
                    quote.marketCap / 8   // current liabilities proxy
                );
                
                // Display full analysis
                displayDetailedAnalysis({
                    ticker,
                    currentPrice,
                    afterHoursPrice,
                    afterHoursChange,
                    change: quote.regularMarketChangePercent,
                    superTrend,
                    bullBearPower,
                    vwapZ, volZ, obvZ, rsiZ, macdZ, cmfZ,
                    range5d, range10d, range30d,
                    entryPrice, stopLoss, takeProfit,
                    sharpe, winRate, maxDD, momentum,
                    factorScore, compositeScore,
                    mScore,
                    watchlistData: WATCHLIST_DATA[ticker]
                });
                
            } catch (error) {
                console.error('Analysis error:', error);
                alert('Error analyzing ' + ticker + '. Please verify ticker and try again.');
                document.getElementById('detailedView').classList.add('hidden');
                document.getElementById('playsGrid').classList.remove('hidden');
            }
        }

        // Display detailed analysis
        function displayDetailedAnalysis(data) {
            const changeColor = data.change >= 0 ? '#10b981' : '#ef4444';
            const ahColor = data.afterHoursChange >= 0 ? '#10b981' : '#ef4444';
            
            const html = `
                <div class="detailed-analysis">
                    <div class="analysis-header">
                        <div class="ticker-display">${data.ticker}</div>
                        <div class="price-display">
                            <div class="current-price" style="color: ${changeColor}">
                                $${data.currentPrice.toFixed(2)} 
                                <span style="font-size: 0.6em">(${data.change > 0 ? '+' : ''}${data.change.toFixed(2)}%)</span>
                            </div>
                            ${data.afterHoursPrice ? `
                                <div class="after-hours" style="color: ${ahColor}">
                                    After Hours: $${data.afterHoursPrice.toFixed(2)} (${data.afterHoursChange > 0 ? '+' : ''}${data.afterHoursChange}%)
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    <!-- TradingView Chart -->
                    <div class="chart-container" id="tradingview_chart"></div>

                    <!-- Composite Scores -->
                    <div class="composite-scores">
                        <div class="score-card">
                            <div class="score-value">${data.compositeScore}</div>
                            <div class="score-label">COMPOSITE SCORE</div>
                            <div style="margin-top: 15px; font-size: 0.9em; color: #aaa;">
                                Multi-factor weighted score
                            </div>
                        </div>
                        <div class="score-card">
                            <div class="score-value">${data.factorScore}</div>
                            <div class="score-label">FACTOR SCORE</div>
                            <div style="margin-top: 15px; font-size: 0.9em; color: #aaa;">
                                Z-score momentum composite
                            </div>
                        </div>
                    </div>

                    <!-- Key Indicators -->
                    <div class="indicators-grid">
                        <div class="indicator-card">
                            <div class="indicator-label">SuperTrend</div>
                            <div class="indicator-value" style="color: ${data.superTrend.trend === 'UP' ? '#10b981' : '#ef4444'}">
                                ${data.superTrend.trend}
                            </div>
                            <div class="indicator-subtext">Level: $${data.superTrend.value}</div>
                        </div>
                        
                        <div class="indicator-card">
                            <div class="indicator-label">Bull Power</div>
                            <div class="indicator-value" style="color: ${data.bullBearPower.bullPower > 0 ? '#10b981' : '#ef4444'}">
                                ${data.bullBearPower.bullPower}%
                            </div>
                            <div class="indicator-subtext">Strength vs EMA(13)</div>
                        </div>
                        
                        <div class="indicator-card">
                            <div class="indicator-label">Bear Power</div>
                            <div class="indicator-value" style="color: ${data.bullBearPower.bearPower < 0 ? '#ef4444' : '#10b981'}">
                                ${data.bullBearPower.bearPower}%
                            </div>
                            <div class="indicator-subtext">Weakness vs EMA(13)</div>
                        </div>
                        
                        <div class="indicator-card">
                            <div class="indicator-label">M Z-Score</div>
                            <div class="indicator-value" style="color: ${data.mScore.rating === 'SAFE' ? '#10b981' : data.mScore.rating === 'GREY' ? '#f59e0b' : '#ef4444'}">
                                ${data.mScore.score}
                            </div>
                            <div class="indicator-subtext">Rating: ${data.mScore.rating}</div>
                        </div>
                        
                        <div class="indicator-card">
                            <div class="indicator-label">Momentum (10 bars)</div>
                            <div class="indicator-value" style="color: ${data.momentum > 50 ? '#10b981' : '#ef4444'}">
                                ${data.momentum}%
                            </div>
                            <div class="indicator-subtext">${data.momentum > 50 ? 'Bullish' : 'Bearish'} bias</div>
                        </div>
                        
                        ${data.watchlistData ? `
                            <div class="indicator-card" style="border: 2px solid #667eea;">
                                <div class="indicator-label">Your CUSUM Signal</div>
                                <div class="indicator-value">${data.watchlistData.cusum}</div>
                                <div class="indicator-subtext">${data.watchlistData.strategy}</div>
                            </div>
                        ` : ''}
                    </div>

                    <!-- Z-Scores Section -->
                    <div class="z-scores-section">
                        <div class="z-scores-title">üìä Z-Score Analytics Suite</div>
                        <div class="z-scores-grid">
                            <div class="z-score-item">
                                <div class="indicator-label">VWAP Z</div>
                                <div class="metric-value" style="color: ${Math.abs(data.vwapZ) > 2 ? '#ef4444' : '#10b981'}">${data.vwapZ}</div>
                            </div>
                            <div class="z-score-item">
                                <div class="indicator-label">VOL Z</div>
                                <div class="metric-value" style="color: ${Math.abs(data.volZ) > 2 ? '#ef4444' : '#10b981'}">${data.volZ}</div>
                            </div>
                            <div class="z-score-item">
                                <div class="indicator-label">OBV Z</div>
                                <div class="metric-value" style="color: ${Math.abs(data.obvZ) > 2 ? '#ef4444' : '#10b981'}">${data.obvZ}</div>
                            </div>
                            <div class="z-score-item">
                                <div class="indicator-label">RSI Z</div>
                                <div class="metric-value" style="color: ${Math.abs(data.rsiZ) > 2 ? '#ef4444' : '#10b981'}">${data.rsiZ}</div>
                            </div>
                            <div class="z-score-item">
                                <div class="indicator-label">MACD Z</div>
                                <div class="metric-value" style="color: ${Math.abs(data.macdZ) > 2 ? '#ef4444' : '#10b981'}">${data.macdZ}</div>
                            </div>
                            <div class="z-score-item">
                                <div class="indicator-label">CMF Z</div>
                                <div class="metric-value" style="color: ${Math.abs(data.cmfZ) > 2 ? '#ef4444' : '#10b981'}">${data.cmfZ}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Projected Ranges -->
                    <div class="ranges-section">
                        <div class="z-scores-title">üéØ Projected Price Ranges (95% Confidence)</div>
                        <div class="ranges-grid">
                            <div class="range-box">
                                <div class="range-label">5-Day Range</div>
                                <div class="range-values">
                                    $${data.range5d.lower} - $${data.range5d.upper}
                                </div>
                            </div>
                            <div class="range-box">
                                <div class="range-label">10-Day Range</div>
                                <div class="range-values">
                                    $${data.range10d.lower} - $${data.range10d.upper}
                                </div>
                            </div>
                            <div class="range-box">
                                <div class="range-label">30-Day Range</div>
                                <div class="range-values">
                                    $${data.range30d.lower} - $${data.range30d.upper}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Scalping Strategy -->
                    <div class="scalping-strategy">
                        <div class="z-scores-title">‚ö° Scalping Entry/Exit Strategy</div>
                        <div class="scalping-grid">
                            <div class="scalping-box">
                                <div class="range-label">ENTRY</div>
                                <div class="range-values" style="color: #10b981">$${data.entryPrice.toFixed(2)}</div>
                            </div>
                            <div class="scalping-box">
                                <div class="range-label">STOP LOSS</div>
                                <div class="range-values" style="color: #ef4444">$${data.stopLoss}</div>
                            </div>
                            <div class="scalping-box">
                                <div class="range-label">TAKE PROFIT</div>
                                <div class="range-values" style="color: #10b981">$${data.takeProfit}</div>
                            </div>
                        </div>
                        <div style="margin-top: 15px; text-align: center; color: #aaa; font-size: 0.9em;">
                            Based on 1.5x ATR stop, 2.5x ATR target
                        </div>
                    </div>

                    <!-- Performance Metrics -->
                    <div class="performance-metrics">
                        <div class="z-scores-title">üìà Performance Analytics</div>
                        <div class="indicators-grid">
                            <div class="indicator-card">
                                <div class="indicator-label">Sharpe Ratio</div>
                                <div class="indicator-value" style="color: ${data.sharpe > 1 ? '#10b981' : data.sharpe > 0 ? '#f59e0b' : '#ef4444'}">
                                    ${data.sharpe}
                                </div>
                                <div class="indicator-subtext">Risk-adjusted return</div>
                            </div>
                            <div class="indicator-card">
                                <div class="indicator-label">Win Rate</div>
                                <div class="indicator-value" style="color: ${data.winRate > 50 ? '#10b981' : '#ef4444'}">
                                    ${data.winRate}%
                                </div>
                                <div class="indicator-subtext">Profitable days</div>
                            </div>
                            <div class="indicator-card">
                                <div class="indicator-label">Max Drawdown</div>
                                <div class="indicator-value" style="color: #ef4444">
                                    -${data.maxDD}%
                                </div>
                                <div class="indicator-subtext">Peak to trough</div>
                            </div>
                        </div>
                    </div>

                    ${data.watchlistData ? `
                        <div style="background: rgba(102, 126, 234, 0.15); border-left: 4px solid #667eea; padding: 25px; border-radius: 12px; margin-top: 25px;">
                            <div style="font-size: 1.5em; color: #667eea; font-weight: 700; margin-bottom: 15px;">
                                üéØ Your Proprietary Signal
                            </div>
                            <div style="font-size: 1.1em; line-height: 1.8; color: #ddd;">
                                ${data.watchlistData.reasoning}
                            </div>
                        </div>
                    ` : ''}

                    <button onclick="backToGrid()" class="btn btn-scanner" style="width: 100%; margin-top: 30px; font-size: 1.2em; padding: 20px;">
                        ‚Üê BACK TO OPPORTUNITIES
                    </button>
                </div>
            `;
            
            document.getElementById('detailedView').innerHTML = html;
            
            // Initialize TradingView widget
            new TradingView.widget({
                "autosize": true,
                "symbol": data.ticker,
                "interval": "D",
                "timezone": "America/New_York",
                "theme": "dark",
                "style": "1",
                "locale": "en",
                "enable_publishing": false,
                "allow_symbol_change": true,
                "container_id": "tradingview_chart",
                "height": 500,
                "studies": [
                    "STD;SuperTrend",
                    "STD;MACD",
                    "STD;RSI",
                    "STD;Volume"
                ]
            });
            
            document.getElementById('marketNarrative').textContent = 
                `"Deep analysis complete for ${data.ticker}. Composite Score: ${data.compositeScore} | Factor Score: ${data.factorScore}"`;
        }

        // Load top plays on startup
        window.addEventListener('load', () => {
            loadTopPlays();
        });

        async function loadTopPlays() {
            const tickers = Object.keys(WATCHLIST_DATA);
            const plays = [];

            for (const ticker of tickers) {
                try {
                    const yahooData = await fetchYahooData(ticker);
                    
                    if (yahooData.success) {
                        const quote = yahooData.quote;
                        const watchlistData = WATCHLIST_DATA[ticker];
                        
                        plays.push({
                            ticker,
                            price: quote.regularMarketPrice,
                            change: quote.regularMarketChangePercent,
                            ...watchlistData
                        });
                    } else {
                        // Fallback with static data
                        plays.push({
                            ticker,
                            price: 0,
                            change: 0,
                            ...WATCHLIST_DATA[ticker]
                        });
                    }
                } catch (error) {
                    console.error(`Error loading ${ticker}:`, error);
                    plays.push({
                        ticker,
                        price: 0,
                        change: 0,
                        ...WATCHLIST_DATA[ticker]
                    });
                }
            }

            displayPlays(plays);
            updateNarrative(plays);
        }

        function displayPlays(plays) {
            const grid = document.getElementById('playsGrid');
            
            if (plays.length === 0) {
                grid.innerHTML = '<div class="loading"><p style="font-size: 1.3em;">No opportunities found. Market in neutral zone.</p></div>';
                return;
            }

            grid.innerHTML = plays.map(play => {
                const changeColor = play.change >= 0 ? '#10b981' : '#ef4444';
                
                return `
                    <div class="play-card" onclick="document.getElementById('tickerInput').value='${play.ticker}'; analyzeStock();">
                        <div class="play-ticker">
                            ${play.ticker} 
                            <span style="color: ${changeColor}; font-size: 0.6em;">
                                ${play.change > 0 ? '+' : ''}${play.change.toFixed(2)}%
                            </span>
                        </div>
                        <div class="play-story-name">"${getStoryName(play)}"</div>
                        
                        <div class="play-metrics">
                            <div class="play-metric">
                                <div class="metric-label">CUSUM</div>
                                <div class="metric-value">${play.cusum}</div>
                            </div>
                            <div class="play-metric">
                                <div class="metric-label">Inst Score</div>
                                <div class="metric-value">${play.instScore}</div>
                            </div>
                            <div class="play-metric">
                                <div class="metric-label">Volatility</div>
                                <div class="metric-value">${play.volatility}%</div>
                            </div>
                            <div class="play-metric">
                                <div class="metric-label">Momentum</div>
                                <div class="metric-value" style="color: ${play.momentum > -50 ? '#10b981' : '#ef4444'}">
                                    ${play.momentum}%
                                </div>
                            </div>
                        </div>
                        
                        <div class="play-signal">
                            <strong style="color: #10b981; font-size: 1.1em;">${play.strategy}</strong><br>
                            <small style="color: #aaa;">Regime: ${play.regimeDetection}% | Vol: ${play.volatility}%</small>
                        </div>
                        
                        <div style="margin-top: 18px; padding: 18px; background: rgba(102, 126, 234, 0.12); border-radius: 10px; font-size: 0.95em; line-height: 1.7;">
                            <strong style="color: #667eea;">üìä Analysis:</strong><br>
                            ${play.reasoning}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getStoryName(play) {
            if (play.cusum < -2 && play.volatility > 80) return 'The Perfect Storm';
            if (play.cusum < -2) return 'Deep Value Zone';
            if (play.cusum < -1.5) return 'Mean Reversion Setup';
            if (play.cusum < -1) return 'Accumulation Phase';
            if (play.volatility > 100) return 'Volatility Explosion';
            if (play.instScore > 50) return 'Institutional Favorite';
            return 'High Probability Trade';
        }

        function updateNarrative(plays) {
            const narrative = plays.length > 0 
                ? `"Identified ${plays.length} elite setups. ${plays[0].ticker} leads with CUSUM ${plays[0].cusum} and Inst Score ${plays[0].instScore}. All signals validated by proprietary algorithms."`
                : '"Market scanning in progress. Awaiting high-conviction setups."';
            
            document.getElementById('marketNarrative').textContent = narrative;
        }

        function backToGrid() {
            document.getElementById('detailedView').classList.add('hidden');
            document.getElementById('playsGrid').classList.remove('hidden');
            loadTopPlays();
        }

        function runFullScanner() {
            document.getElementById('playsGrid').innerHTML = '<div class="loading"><div class="spinner"></div><p style="font-size: 1.3em;">Scanning all markets with proprietary indicators...</p></div>';
            setTimeout(() => loadTopPlays(), 1000);
        }

        function viewNewsBrief() {
            const grid = document.getElementById('playsGrid');
            const tickers = Object.keys(WATCHLIST_DATA);
            
            const briefHTML = `
                <div style="background: linear-gradient(145deg, #2d2d44 0%, #1f1f2e 100%); border-radius: 25px; padding: 50px; max-width: 1200px; margin: 0 auto; box-shadow: 0 20px 50px rgba(0,0,0,0.5);">
                    <h2 style="font-size: 2.5em; color: #667eea; margin-bottom: 35px; text-align: center;">üì∞ Elite Market Intelligence</h2>
                    
                    <div style="background: rgba(102, 126, 234, 0.12); padding: 30px; border-radius: 18px; margin-bottom: 30px; border-left: 5px solid #667eea;">
                        <h3 style="color: #10b981; margin-bottom: 18px; font-size: 1.6em;">üåÖ Pre-Market Overview</h3>
                        <p style="line-height: 2; font-size: 1.1em;">Your ThinkScript CUSUM indicator identified ${tickers.length} stocks in extreme Bear Deviation zones. Average Institutional Score of ${Math.round(Object.values(WATCHLIST_DATA).reduce((sum, d) => sum + d.instScore, 0) / tickers.length)} confirms smart money accumulation during selloff.</p>
                    </div>
                    
                    <div style="background: rgba(102, 126, 234, 0.12); padding: 30px; border-radius: 18px; margin-bottom: 30px; border-left: 5px solid #667eea;">
                        <h3 style="color: #667eea; margin-bottom: 18px; font-size: 1.6em;">üéØ Today's Priority Targets</h3>
                        <ul style="line-height: 2; padding-left: 25px; font-size: 1.1em;">
                            <li><strong>${tickers[0]}</strong>: CUSUM ${WATCHLIST_DATA[tickers[0]].cusum} - Deepest oversold signal</li>
                            <li><strong>${tickers[1]}</strong>: Regime ${WATCHLIST_DATA[tickers[1]].regimeDetection}% - Maximum volatility expansion</li>
                            <li><strong>${tickers[2]}</strong>: Inst ${WATCHLIST_DATA[tickers[2]].instScore} - Highest institutional backing</li>
                            <li><strong>${tickers[3]}</strong>: Momentum ${WATCHLIST_DATA[tickers[3]].momentum}% - Strong reversal setup</li>
                        </ul>
                    </div>
                    
                    <div style="background: rgba(239, 68, 68, 0.12); padding: 30px; border-radius: 18px; margin-bottom: 30px; border-left: 5px solid #ef4444;">
                        <h3 style="color: #ef4444; margin-bottom: 18px; font-size: 1.6em;">‚ö†Ô∏è Risk Management Notes</h3>
                        <p style="line-height: 2; font-size: 1.1em;">Average volatility at ${Math.round(Object.values(WATCHLIST_DATA).reduce((sum, d) => sum + d.volatility, 0) / tickers.length)}% requires strict position sizing. Your regime detection shows expansion mode - expect continued swings. Use ATR-based stops.</p>
                    </div>
                    
                    <div style="background: rgba(245, 158, 11, 0.12); padding: 30px; border-radius: 18px; margin-bottom: 30px; border-left: 5px solid #f59e0b;">
                        <h3 style="color: #f59e0b; margin-bottom: 18px; font-size: 1.6em;">üí° Trading Strategy</h3>
                        <p style="line-height: 2; font-size: 1.1em;">All watchlist names showing negative CUSUM = mean reversion candidates. SuperTrend and Bull/Bear Power will confirm entries. Monitor Z-scores (VWAP, OBV, CMF) for timing. Target Sharpe > 1.5, Win Rate > 55%.</p>
                    </div>
                    
                    <button onclick="backToGrid()" class="btn btn-scanner" style="width: 100%; margin-top: 25px; font-size: 1.3em; padding: 22px;">
                        ‚Üê BACK TO OPPORTUNITIES
                    </button>
                </div>
            `;
            
            grid.innerHTML = briefHTML;
            document.getElementById('marketNarrative').textContent = '"Reading today\'s elite market intelligence brief..."';
        }
    </script>
</body>
</html>
